<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="icon" type="image/png" href="/Logo-Ru_1754635713718.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ | Bunyod-Tour</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="/public/css/common.css">
    
    <!-- i18n -->
    <script src="/public/js/i18n.js" defer></script>
    <script src="/public/js/utils.js" defer></script>
    <script src="/public/js/layout-loader.js" defer></script>
</head>
<body style="background: #f3f4f6;">
    <!-- Header –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    <div id="header-container"></div>
    
    <!-- Main Content -->
    <main class="min-h-screen py-20">
        <div class="max-w-3xl mx-auto px-6">
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <span data-translate="reviews.universal_title">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</span>
                </h1>
                <p class="text-gray-600 mb-8" data-translate="reviews.universal_desc">
                    –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–∞—à–∏–º–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏ –æ —Ç—É—Ä–µ, –≥–∏–¥–µ –∏–ª–∏ –æ–±–æ–∏—Ö
                </p>
                
                <form id="reviewForm" class="space-y-6">
                    <!-- –ò–º—è -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="form.your_name">–í–∞—à–µ –∏–º—è</span> *
                        </label>
                        <input type="text" id="reviewerName" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-transparent"
                               data-translate-placeholder="form.name_placeholder"
                               placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                    </div>
                    
                    <!-- –í—ã–±–æ—Ä —Ç—É—Ä–∞ -->
                    <div id="tourSelectContainer">
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="form.select_tour">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—É—Ä</span> *
                        </label>
                        <select id="tourSelect" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-transparent">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—É—Ä–æ–≤...</option>
                        </select>
                    </div>
                    <!-- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç—É—Ä (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏ tourId –ø–µ—Ä–µ–¥–∞–Ω —á–µ—Ä–µ–∑ URL) -->
                    <div id="tourLockedContainer" class="hidden">
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="form.tour">–¢—É—Ä</span>
                        </label>
                        <div class="w-full px-4 py-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-700">
                            <span id="tourLockedName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <input type="hidden" id="tourLockedId" value="">
                    </div>
                    
                    <!-- –í—ã–±–æ—Ä –≥–∏–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
                    <div id="guideSelectContainer">
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="form.select_guide">–í—ã–±–µ—Ä–∏—Ç–µ –≥–∏–¥–∞</span>
                            <span class="text-gray-500 text-sm" data-translate="form.optional">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                        </label>
                        <select id="guideSelect"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-transparent">
                            <option value="" data-translate="form.guide_not_specified">–ì–∏–¥ –Ω–µ —É–∫–∞–∑–∞–Ω</option>
                        </select>
                        <p class="text-sm text-gray-500 mt-1" data-translate="form.guide_help">–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –æ—Ü–µ–Ω–∏—Ç—å –≥–∏–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –≤–∞—Å —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–ª</p>
                    </div>
                    <!-- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥–∏–¥ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏ guideId –ø–µ—Ä–µ–¥–∞–Ω —á–µ—Ä–µ–∑ URL) -->
                    <div id="guideLockedContainer" class="hidden">
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="form.guide">–ì–∏–¥</span>
                        </label>
                        <div class="w-full px-4 py-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-700">
                            <span id="guideLockedName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <input type="hidden" id="guideLockedId" value="">
                    </div>
                    
                    <!-- –†–µ–π—Ç–∏–Ω–≥ —Ç—É—Ä–∞ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="reviews.tour_rating">–†–µ–π—Ç–∏–Ω–≥ —Ç—É—Ä–∞</span> *
                        </label>
                        <div class="flex gap-2" id="tourRatingStars">
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="1"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="2"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="3"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="4"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="tourRating" required>
                        <p class="text-sm text-red-500 mt-1 hidden" id="tourRatingError" data-translate="form.tour_rating_error">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ä–µ–π—Ç–∏–Ω–≥ —Ç—É—Ä–∞</p>
                    </div>
                    
                    <!-- –†–µ–π—Ç–∏–Ω–≥ –≥–∏–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="reviews.guide_rating">–†–µ–π—Ç–∏–Ω–≥ –≥–∏–¥–∞</span>
                            <span class="text-gray-500 text-sm" data-translate="form.optional">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                        </label>
                        <div class="flex gap-2" id="guideRatingStars">
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="1"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="2"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="3"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="4"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="guideRating">
                    </div>
                    
                    <!-- –¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="reviews.your_review">–í–∞—à –æ—Ç–∑—ã–≤</span>
                            <span class="text-gray-500 text-sm" data-translate="form.optional">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                        </label>
                        <textarea id="reviewText" rows="6"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-transparent"
                                  data-translate-placeholder="form.review_placeholder"
                                  placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –æ–ø—ã—Ç–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è..."></textarea>
                    </div>
                    
                    <!-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="reviews.photos">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</span>
                            <span class="text-gray-500 text-sm" data-translate="form.photos_optional">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –¥–æ 5 —Ñ–æ—Ç–æ)</span>
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="file" id="reviewPhotos" accept="image/*" multiple class="hidden">
                            <button type="button" id="customFileBtn" 
                                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg border border-gray-300 transition-colors">
                                <span data-translate="form.choose_files">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</span>
                            </button>
                            <span id="fileSelectedText" class="text-gray-500" data-translate="form.no_file_selected">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1" data-translate="form.photos_limit">–ú–∞–∫—Å–∏–º—É–º 5 —Ñ–æ—Ç–æ, –¥–æ 5 –ú–ë –∫–∞–∂–¥–æ–µ</p>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                    <button type="submit" id="submitBtn"
                            class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-4 px-6 rounded-lg transition-all duration-300 hover:scale-105">
                        <span data-translate="btn.submit_review">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</span>
                    </button>
                    
                    <p class="text-sm text-gray-500 text-center">
                        <span data-translate="reviews.moderation_notice">
                            –í–∞—à –æ—Ç–∑—ã–≤ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π
                        </span>
                    </p>
                </form>
                
                <!-- Success Message -->
                <div id="successMessage" class="hidden mt-6 p-4 bg-green-100 border border-green-300 text-green-800 rounded-lg">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span data-translate="reviews.success_message">
                        –°–ø–∞—Å–∏–±–æ! –í–∞—à –æ—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏ –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –ø–æ—Å–ª–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏.
                    </span>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    <div id="footer-container"></div>
    
    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—É—Ä–æ–≤ –∏ –≥–∏–¥–æ–≤
        async function loadTours() {
            try {
                const response = await fetch('/api/tours');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const select = document.getElementById('tourSelect');
                    const currentLang = localStorage.getItem('selectedLanguage') || 'ru';
                    
                    const lang = localStorage.getItem('selectedLanguage') || 'ru';
                    const selectTourText = (window.translations && window.translations['form.select_tour_option']) 
                        ? (window.translations['form.select_tour_option'][lang] || '–í—ã–±–µ—Ä–∏—Ç–µ —Ç—É—Ä...') 
                        : '–í—ã–±–µ—Ä–∏—Ç–µ —Ç—É—Ä...';
                    select.innerHTML = '<option value="">' + selectTourText + '</option>';
                    data.data.forEach(tour => {
                        const title = typeof tour.title === 'object' 
                            ? (tour.title[currentLang] || tour.title.ru || tour.title.en)
                            : tour.title;
                        
                        const option = document.createElement('option');
                        option.value = tour.id;
                        option.textContent = title;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading tours:', error);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≥–∏–¥–æ–≤
        async function loadGuides() {
            try {
                const response = await fetch('/api/guides');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const select = document.getElementById('guideSelect');
                    
                    const lang = localStorage.getItem('selectedLanguage') || 'ru';
                    const guideNotSpecText = (window.translations && window.translations['form.guide_not_specified']) 
                        ? (window.translations['form.guide_not_specified'][lang] || '–ì–∏–¥ –Ω–µ —É–∫–∞–∑–∞–Ω') 
                        : '–ì–∏–¥ –Ω–µ —É–∫–∞–∑–∞–Ω';
                    select.innerHTML = '<option value="">' + guideNotSpecText + '</option>';
                    data.data.forEach(guide => {
                        const name = typeof guide.name === 'object' ? (guide.name[localStorage.getItem('language') || 'ru'] || guide.name.ru || guide.name.en || '–ì–∏–¥') : (guide.name || `${guide.firstName || ''} ${guide.lastName || ''}`);
                        
                        const option = document.createElement('option');
                        option.value = guide.id;
                        option.textContent = name.trim();
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading guides:', error);
            }
        }
        
        // –†–µ–π—Ç–∏–Ω–≥ –∑–≤—ë–∑–¥–∞–º–∏
        function setupStarRating(containerId, inputId) {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);
            const stars = container.querySelectorAll('.fa-star');
            
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    input.value = rating;
                    
                    stars.forEach((s, index) => {
                        if (index < rating) {
                            s.classList.remove('text-gray-300');
                            s.classList.add('text-yellow-500');
                        } else {
                            s.classList.remove('text-yellow-500');
                            s.classList.add('text-gray-300');
                        }
                    });
                });
            });
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('reviewForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ —Ç—É—Ä–∞
            const tourRatingValue = document.getElementById('tourRating').value;
            if (!tourRatingValue) {
                document.getElementById('tourRatingError').classList.remove('hidden');
                return;
            }
            document.getElementById('tourRatingError').classList.add('hidden');
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                let photoUrls = [];
                const photosInput = document.getElementById('reviewPhotos');
                
                if (photosInput.files.length > 0) {
                    const formData = new FormData();
                    for (let i = 0; i < Math.min(photosInput.files.length, 5); i++) {
                        formData.append('photos', photosInput.files[i]);
                    }
                    
                    const uploadResponse = await fetch('/api/reviews/upload-photos', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadData = await uploadResponse.json();
                    if (uploadData.success) {
                        photoUrls = uploadData.data.photos;
                    }
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–∑—ã–≤
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏–∑ select
                const tourLockedId = document.getElementById('tourLockedId').value;
                const guideLockedId = document.getElementById('guideLockedId').value;
                const tourSelectVal = tourLockedId || document.getElementById('tourSelect').value;
                const guideSelectVal = guideLockedId || document.getElementById('guideSelect').value;
                
                const reviewTextValue = document.getElementById('reviewText').value.trim();
                const reviewData = {
                    reviewerName: document.getElementById('reviewerName').value,
                    tourId: parseInt(tourSelectVal),
                    guideId: guideSelectVal ? parseInt(guideSelectVal) : null,
                    rating: parseInt(document.getElementById('tourRating').value),
                    guideRating: document.getElementById('guideRating').value 
                        ? parseInt(document.getElementById('guideRating').value) 
                        : null,
                    text: reviewTextValue || null,
                    photos: photoUrls.length > 0 ? photoUrls : null
                };
                
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reviewData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('reviewForm').style.display = 'none';
                    document.getElementById('successMessage').classList.remove('hidden');
                    
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤'));
                    submitBtn.disabled = false;
                    submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤';
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞');
                submitBtn.disabled = false;
                submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤';
            }
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async function() {
            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            const preselectedTourId = urlParams.get('tourId');
            const preselectedGuideId = urlParams.get('guideId');
            const preselectedName = urlParams.get('name');
            
            // Debug: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –∏–∑ URL
            console.log('üîç URL params:', { tourId: preselectedTourId, guideId: preselectedGuideId, name: preselectedName });
            console.log('üîç Full URL:', window.location.href);
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–æ –∏–º—è - –∑–∞–ø–æ–ª–Ω—è–µ–º
            if (preselectedName) {
                document.getElementById('reviewerName').value = decodeURIComponent(preselectedName);
            }
            
            const currentLang = localStorage.getItem('selectedLanguage') || 'ru';
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω tourId - —Å—Ä–∞–∑—É –±–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–±–æ—Ä, –ø–æ—Ç–æ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
            if (preselectedTourId) {
                // –°–Ω–∞—á–∞–ª–∞ —Å—Ä–∞–∑—É –±–ª–æ–∫–∏—Ä—É–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID (–¥–æ fetch)
                document.getElementById('tourSelectContainer').classList.add('hidden');
                document.getElementById('tourSelect').removeAttribute('required'); // –£–±–∏—Ä–∞–µ–º required —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞ –ø—Ä–æ—à–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—é
                document.getElementById('tourLockedContainer').classList.remove('hidden');
                document.getElementById('tourLockedName').textContent = `–¢—É—Ä #${preselectedTourId}`;
                document.getElementById('tourLockedId').value = preselectedTourId;
                
                // –ó–∞—Ç–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
                fetch(`/api/tours/${preselectedTourId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data) {
                            const tour = data.data;
                            const title = typeof tour.title === 'object' 
                                ? (tour.title[currentLang] || tour.title.ru || tour.title.en)
                                : tour.title;
                            if (title) {
                                document.getElementById('tourLockedName').textContent = title;
                            }
                        }
                    })
                    .catch(e => console.error('Error loading tour name:', e));
            } else {
                await loadTours();
            }
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω guideId - —Å—Ä–∞–∑—É –±–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–±–æ—Ä, –ø–æ—Ç–æ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–º—è
            if (preselectedGuideId) {
                // –°–Ω–∞—á–∞–ª–∞ —Å—Ä–∞–∑—É –±–ª–æ–∫–∏—Ä—É–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID (–¥–æ fetch)
                document.getElementById('guideSelectContainer').classList.add('hidden');
                document.getElementById('guideLockedContainer').classList.remove('hidden');
                document.getElementById('guideLockedName').textContent = `–ì–∏–¥ #${preselectedGuideId}`;
                document.getElementById('guideLockedId').value = preselectedGuideId;
                
                // –ó–∞—Ç–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–º—è
                fetch(`/api/guides/${preselectedGuideId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data) {
                            const guide = data.data;
                            const name = typeof guide.name === 'object' 
                                ? (guide.name[currentLang] || guide.name.ru || guide.name.en || '–ì–∏–¥')
                                : (guide.name || `${guide.firstName || ''} ${guide.lastName || ''}`);
                            if (name && name.trim()) {
                                document.getElementById('guideLockedName').textContent = name.trim();
                            }
                        }
                    })
                    .catch(e => console.error('Error loading guide name:', e));
            } else {
                await loadGuides();
            }
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–≤—ë–∑–¥—ã —Ç—É—Ä–∞ –∏ –≥–∏–¥–∞
            setupStarRating('tourRatingStars', 'tourRating');
            setupStarRating('guideRatingStars', 'guideRating');
            
            // –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
            const customFileBtn = document.getElementById('customFileBtn');
            const fileInput = document.getElementById('reviewPhotos');
            const fileSelectedText = document.getElementById('fileSelectedText');
            
            customFileBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', () => {
                const lang = localStorage.getItem('selectedLanguage') || 'ru';
                const filesCount = fileInput.files.length;
                
                if (filesCount === 0) {
                    const noFileText = (window.translations && window.translations['form.no_file_selected']) 
                        ? (window.translations['form.no_file_selected'][lang] || '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω') 
                        : '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
                    fileSelectedText.textContent = noFileText;
                } else if (filesCount === 1) {
                    fileSelectedText.textContent = fileInput.files[0].name;
                } else {
                    const filesSelectedText = (window.translations && window.translations['form.files_selected']) 
                        ? (window.translations['form.files_selected'][lang] || '{count} —Ñ–∞–π–ª–æ–≤ –≤—ã–±—Ä–∞–Ω–æ') 
                        : '{count} —Ñ–∞–π–ª–æ–≤ –≤—ã–±—Ä–∞–Ω–æ';
                    fileSelectedText.textContent = filesSelectedText.replace('{count}', filesCount);
                }
            });
        });
    </script>
</body>
</html>
