<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="icon" type="image/png" href="/Logo-Ru_1754635713718.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оставить отзыв | Bunyod-Tour</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="/public/css/common.css">
    
    <!-- i18n -->
    <script src="/public/js/i18n.js" defer></script>
    <script src="/public/js/utils.js" defer></script>
    <script src="/public/js/layout-loader.js" defer></script>
</head>
<body style="background: #f3f4f6;">
    <!-- Header будет загружен динамически -->
    <div id="header-container"></div>
    
    <!-- Main Content -->
    <main class="min-h-screen py-20">
        <div class="max-w-3xl mx-auto px-6">
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <span data-translate="reviews.universal_title">Оставить отзыв</span>
                </h1>
                <p class="text-gray-600 mb-8" data-translate="reviews.universal_desc">
                    Поделитесь вашими впечатлениями о туре, гиде или обоих
                </p>
                
                <form id="reviewForm" class="space-y-6">
                    <!-- Имя -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="form.your_name">Ваше имя</span> *
                        </label>
                        <input type="text" id="reviewerName" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-transparent"
                               placeholder="Иван Иванов">
                    </div>
                    
                    <!-- Выбор тура -->
                    <div id="tourSelectContainer">
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="form.select_tour">Выберите тур</span> *
                        </label>
                        <select id="tourSelect" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-transparent">
                            <option value="">Загрузка туров...</option>
                        </select>
                    </div>
                    <!-- Заблокированный тур (показывается если tourId передан через URL) -->
                    <div id="tourLockedContainer" class="hidden">
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="form.tour">Тур</span>
                        </label>
                        <div class="w-full px-4 py-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-700">
                            <span id="tourLockedName">Загрузка...</span>
                        </div>
                        <input type="hidden" id="tourLockedId" value="">
                    </div>
                    
                    <!-- Выбор гида (опционально) -->
                    <div id="guideSelectContainer">
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="form.select_guide">Выберите гида</span>
                            <span class="text-gray-500 text-sm">(необязательно)</span>
                        </label>
                        <select id="guideSelect"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-transparent">
                            <option value="">Гид не указан</option>
                        </select>
                        <p class="text-sm text-gray-500 mt-1" data-translate="form.guide_help">Если хотите оценить гида, который вас сопровождал</p>
                    </div>
                    <!-- Заблокированный гид (показывается если guideId передан через URL) -->
                    <div id="guideLockedContainer" class="hidden">
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="form.guide">Гид</span>
                        </label>
                        <div class="w-full px-4 py-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-700">
                            <span id="guideLockedName">Загрузка...</span>
                        </div>
                        <input type="hidden" id="guideLockedId" value="">
                    </div>
                    
                    <!-- Рейтинг тура -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="reviews.tour_rating">Рейтинг тура</span> *
                        </label>
                        <div class="flex gap-2" id="tourRatingStars">
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="1"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="2"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="3"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="4"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="tourRating" required>
                        <p class="text-sm text-red-500 mt-1 hidden" id="tourRatingError">Пожалуйста, укажите рейтинг тура</p>
                    </div>
                    
                    <!-- Рейтинг гида (опционально) -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="reviews.guide_rating">Рейтинг гида</span>
                            <span class="text-gray-500 text-sm">(необязательно)</span>
                        </label>
                        <div class="flex gap-2" id="guideRatingStars">
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="1"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="2"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="3"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="4"></i>
                            <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-500 transition-colors" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="guideRating">
                    </div>
                    
                    <!-- Текст отзыва -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="reviews.your_review">Ваш отзыв</span> *
                        </label>
                        <textarea id="reviewText" required rows="6"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-transparent"
                                  placeholder="Расскажите о вашем опыте путешествия..."></textarea>
                    </div>
                    
                    <!-- Фотографии (опционально) -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">
                            <span data-translate="reviews.photos">Фотографии</span>
                            <span class="text-gray-500 text-sm">(необязательно, до 5 фото)</span>
                        </label>
                        <input type="file" id="reviewPhotos" accept="image/*" multiple
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                        <p class="text-sm text-gray-500 mt-1">Максимум 5 фото, до 5 МБ каждое</p>
                    </div>
                    
                    <!-- Кнопка отправки -->
                    <button type="submit" id="submitBtn"
                            class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-4 px-6 rounded-lg transition-all duration-300 hover:scale-105">
                        <span data-translate="btn.submit_review">Отправить отзыв</span>
                    </button>
                    
                    <p class="text-sm text-gray-500 text-center">
                        <span data-translate="reviews.moderation_notice">
                            Ваш отзыв будет проверен модератором перед публикацией
                        </span>
                    </p>
                </form>
                
                <!-- Success Message -->
                <div id="successMessage" class="hidden mt-6 p-4 bg-green-100 border border-green-300 text-green-800 rounded-lg">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span data-translate="reviews.success_message">
                        Спасибо! Ваш отзыв успешно отправлен и будет опубликован после модерации.
                    </span>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer будет загружен динамически -->
    <div id="footer-container"></div>
    
    <script>
        // Загрузка туров и гидов
        async function loadTours() {
            try {
                const response = await fetch('/api/tours');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const select = document.getElementById('tourSelect');
                    const currentLang = localStorage.getItem('selectedLanguage') || 'ru';
                    
                    select.innerHTML = '<option value="">Выберите тур...</option>';
                    data.data.forEach(tour => {
                        const title = typeof tour.title === 'object' 
                            ? (tour.title[currentLang] || tour.title.ru || tour.title.en)
                            : tour.title;
                        
                        const option = document.createElement('option');
                        option.value = tour.id;
                        option.textContent = title;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading tours:', error);
            }
        }
        
        // Загрузка гидов
        async function loadGuides() {
            try {
                const response = await fetch('/api/guides');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const select = document.getElementById('guideSelect');
                    
                    select.innerHTML = '<option value="">Гид не указан</option>';
                    data.data.forEach(guide => {
                        const name = typeof guide.name === 'object' ? (guide.name[localStorage.getItem('language') || 'ru'] || guide.name.ru || guide.name.en || 'Гид') : (guide.name || `${guide.firstName || ''} ${guide.lastName || ''}`);
                        
                        const option = document.createElement('option');
                        option.value = guide.id;
                        option.textContent = name.trim();
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading guides:', error);
            }
        }
        
        // Рейтинг звёздами
        function setupStarRating(containerId, inputId) {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);
            const stars = container.querySelectorAll('.fa-star');
            
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    input.value = rating;
                    
                    stars.forEach((s, index) => {
                        if (index < rating) {
                            s.classList.remove('text-gray-300');
                            s.classList.add('text-yellow-500');
                        } else {
                            s.classList.remove('text-yellow-500');
                            s.classList.add('text-gray-300');
                        }
                    });
                });
            });
        }
        
        // Отправка формы
        document.getElementById('reviewForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            
            // Валидация рейтинга тура
            const tourRatingValue = document.getElementById('tourRating').value;
            if (!tourRatingValue) {
                document.getElementById('tourRatingError').classList.remove('hidden');
                return;
            }
            document.getElementById('tourRatingError').classList.add('hidden');
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Отправка...';
            
            try {
                // Загружаем фото (если есть)
                let photoUrls = [];
                const photosInput = document.getElementById('reviewPhotos');
                
                if (photosInput.files.length > 0) {
                    const formData = new FormData();
                    for (let i = 0; i < Math.min(photosInput.files.length, 5); i++) {
                        formData.append('photos', photosInput.files[i]);
                    }
                    
                    const uploadResponse = await fetch('/api/reviews/upload-photos', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadData = await uploadResponse.json();
                    if (uploadData.success) {
                        photoUrls = uploadData.data.photos;
                    }
                }
                
                // Отправляем отзыв
                // Используем заблокированные значения если они есть, иначе из select
                const tourLockedId = document.getElementById('tourLockedId').value;
                const guideLockedId = document.getElementById('guideLockedId').value;
                const tourSelectVal = tourLockedId || document.getElementById('tourSelect').value;
                const guideSelectVal = guideLockedId || document.getElementById('guideSelect').value;
                
                const reviewData = {
                    reviewerName: document.getElementById('reviewerName').value,
                    tourId: parseInt(tourSelectVal),
                    guideId: guideSelectVal ? parseInt(guideSelectVal) : null,
                    rating: parseInt(document.getElementById('tourRating').value),
                    guideRating: document.getElementById('guideRating').value 
                        ? parseInt(document.getElementById('guideRating').value) 
                        : null,
                    text: document.getElementById('reviewText').value,
                    photos: photoUrls.length > 0 ? photoUrls : null
                };
                
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reviewData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('reviewForm').style.display = 'none';
                    document.getElementById('successMessage').classList.remove('hidden');
                    
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else {
                    alert('Ошибка: ' + (data.message || 'Не удалось отправить отзыв'));
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Отправить отзыв';
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                alert('Ошибка при отправке отзыва');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Отправить отзыв';
            }
        });
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', async function() {
            // Получаем параметры из URL
            const urlParams = new URLSearchParams(window.location.search);
            const preselectedTourId = urlParams.get('tourId');
            const preselectedGuideId = urlParams.get('guideId');
            const preselectedName = urlParams.get('name');
            
            // Если передано имя - заполняем
            if (preselectedName) {
                document.getElementById('reviewerName').value = decodeURIComponent(preselectedName);
            }
            
            const currentLang = localStorage.getItem('selectedLanguage') || 'ru';
            
            // Если передан tourId - сразу блокируем выбор, потом загружаем название
            if (preselectedTourId) {
                // Сначала сразу блокируем и устанавливаем ID (до fetch)
                document.getElementById('tourSelectContainer').classList.add('hidden');
                document.getElementById('tourSelect').removeAttribute('required'); // Убираем required чтобы форма прошла валидацию
                document.getElementById('tourLockedContainer').classList.remove('hidden');
                document.getElementById('tourLockedName').textContent = `Тур #${preselectedTourId}`;
                document.getElementById('tourLockedId').value = preselectedTourId;
                
                // Затем асинхронно загружаем название
                fetch(`/api/tours/${preselectedTourId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data) {
                            const tour = data.data;
                            const title = typeof tour.title === 'object' 
                                ? (tour.title[currentLang] || tour.title.ru || tour.title.en)
                                : tour.title;
                            if (title) {
                                document.getElementById('tourLockedName').textContent = title;
                            }
                        }
                    })
                    .catch(e => console.error('Error loading tour name:', e));
            } else {
                await loadTours();
            }
            
            // Если передан guideId - сразу блокируем выбор, потом загружаем имя
            if (preselectedGuideId) {
                // Сначала сразу блокируем и устанавливаем ID (до fetch)
                document.getElementById('guideSelectContainer').classList.add('hidden');
                document.getElementById('guideLockedContainer').classList.remove('hidden');
                document.getElementById('guideLockedName').textContent = `Гид #${preselectedGuideId}`;
                document.getElementById('guideLockedId').value = preselectedGuideId;
                
                // Затем асинхронно загружаем имя
                fetch(`/api/guides/${preselectedGuideId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data) {
                            const guide = data.data;
                            const name = typeof guide.name === 'object' 
                                ? (guide.name[currentLang] || guide.name.ru || guide.name.en || 'Гид')
                                : (guide.name || `${guide.firstName || ''} ${guide.lastName || ''}`);
                            if (name && name.trim()) {
                                document.getElementById('guideLockedName').textContent = name.trim();
                            }
                        }
                    })
                    .catch(e => console.error('Error loading guide name:', e));
            } else {
                await loadGuides();
            }
            
            // Настраиваем звёзды тура и гида
            setupStarRating('tourRatingStars', 'tourRating');
            setupStarRating('guideRatingStars', 'guideRating');
        });
    </script>
</body>
</html>
