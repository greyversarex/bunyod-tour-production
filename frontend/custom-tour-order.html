<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="icon" type="image/png" href="/Logo-Ru_1754635713718.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="custom_tour_page_title">–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—É—Ä - Bunyod-Tour</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script defer src="/public/js/i18n.js?v=1.6"></script>
    <script defer src="/public/js/layout-loader.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .tourist-item {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .component-card {
            transition: all 0.2s ease;
        }
        
        .component-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .component-card.selected {
            border-color: #3E3E3E;
            background-color: #F3F4F6;
        }
        
        .add-tourist-btn {
            background-color: #3E3E3E;
        }
        
        .add-tourist-btn:hover {
            background-color: #2F2F2F;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="header-container"></div>

    <main class="bg-gray-50 py-12">
        <div class="max-w-5xl mx-auto px-6">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-900 mb-4" data-i18n="custom_tour_main_title">–°–æ–∑–¥–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—É—Ä</h1>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto" data-i18n="custom_tour_main_subtitle">
                    –°–æ–∑–¥–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç—É—Ä –ø–æ–¥ –≤–∞—à–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è. –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—ã, –≥–æ—Ä–æ–¥–∞ –∏ —É—Å–ª—É–≥–∏.
                </p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-8 mb-12">
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-2" data-i18n="custom_tour_form_title">–ó–∞–∫–∞–∑–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—É—Ä</h2>
                    <p class="text-gray-600" data-i18n="custom_tour_form_subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –º—ã —Å–æ–∑–¥–∞–¥–∏–º –¥–ª—è –≤–∞—Å –∏–¥–µ–∞–ª—å–Ω—ã–π —Ç—É—Ä</p>
                </div>

                <form id="customTourForm" class="space-y-8">
                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4" data-i18n="custom_tour_contact_info">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="fullName" class="block text-sm font-medium text-gray-700 mb-2">
                                    <span data-i18n="custom_tour_fullname">–§–ò–û</span> <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="fullName" name="fullName" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-600 focus:border-transparent"
                                    data-i18n-placeholder="custom_tour_fullname_placeholder"
                                    placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –ø–æ–ª–Ω–æ–µ –∏–º—è">
                            </div>
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                                    <span data-i18n="custom_tour_email">Email</span>
                                </label>
                                <input type="email" id="email" name="email" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-600 focus:border-transparent"
                                    data-i18n-placeholder="custom_tour_email_placeholder"
                                    placeholder="your@email.com">
                            </div>
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                                    <span data-i18n="custom_tour_phone">–¢–µ–ª–µ—Ñ–æ–Ω</span> <span class="text-red-500">*</span>
                                </label>
                                <input type="tel" id="phone" name="phone" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-600 focus:border-transparent"
                                    data-i18n-placeholder="custom_tour_phone_placeholder"
                                    placeholder="+992 XX XXX XXXX">
                            </div>
                        </div>
                    </div>

                    <!-- –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—É—Ä–∞ -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4" data-i18n="custom_tour_duration_title">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—É—Ä–∞</h3>
                        <div>
                            <label for="tourDuration" class="block text-sm font-medium text-gray-700 mb-2">
                                <span data-i18n="custom_tour_days_label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π</span> <span class="text-red-500">*</span>
                            </label>
                            <input type="number" id="tourDuration" name="tourDuration" required min="3"
                                class="w-full md:w-1/3 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-600 focus:border-transparent"
                                data-i18n-placeholder="custom_tour_days_placeholder"
                                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 7"
                                onchange="validateDuration()">
                            <p class="text-sm text-gray-500 mt-2" data-i18n="custom_tour_days_hint">–ö–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∞ —Ç—Ä–µ–±—É–µ—Ç –º–∏–Ω–∏–º—É–º 3 –¥–Ω—è. –ù–∞–ø—Ä–∏–º–µ—Ä: 6 –¥–Ω–µ–π = –¥–æ 2 —Å—Ç—Ä–∞–Ω, 9 –¥–Ω–µ–π = –¥–æ 3 —Å—Ç—Ä–∞–Ω</p>
                            <div id="durationWarning" class="hidden mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5"></i>
                                    <p id="durationWarningText" class="text-sm text-yellow-800">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–Ω–µ–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–∞–Ω</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω –∏ –≥–æ—Ä–æ–¥–æ–≤ -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4" data-i18n="custom_tour_destinations">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
                        
                        <!-- –°—Ç—Ä–∞–Ω—ã -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-3">
                                <span data-i18n="custom_tour_select_countries">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—ã</span> <span class="text-red-500">*</span>
                            </label>
                            <div id="countriesContainer" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <div class="text-center text-gray-500 py-4">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>
                                    <span data-i18n="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                            </div>
                        </div>

                        <!-- –ì–æ—Ä–æ–¥–∞ -->
                        <div id="citiesSection" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-3" data-i18n="custom_tour_select_cities">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥–∞</label>
                            <div id="citiesContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                        </div>
                    </div>

                    <!-- –°–ø–∏—Å–æ–∫ —Ç—É—Ä–∏—Å—Ç–æ–≤ -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4" data-i18n="custom_tour_tourists_list">–°–ø–∏—Å–æ–∫ —Ç—É—Ä–∏—Å—Ç–æ–≤</h3>
                        <div class="mb-4">
                            <label for="touristName" class="block text-sm font-medium text-gray-700 mb-2" data-i18n="custom_tour_tourist_name">–ò–º—è —Ç—É—Ä–∏—Å—Ç–∞</label>
                            <div class="flex gap-3">
                                <input type="text" id="touristName" 
                                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-600 focus:border-transparent"
                                    data-i18n-placeholder="custom_tour_tourist_name_placeholder"
                                    placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –Ω–∞–∂–º–∏—Ç–µ '–î–æ–±–∞–≤–∏—Ç—å'">
                                <button type="button" onclick="addTourist()" 
                                    class="add-tourist-btn px-6 py-3 text-white font-semibold rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>
                                    <span data-i18n="custom_tour_add_tourist">–î–æ–±–∞–≤–∏—Ç—å</span>
                                </button>
                            </div>
                        </div>
                        <div id="touristsList" class="space-y-2"></div>
                        <p class="text-sm text-gray-500 mt-2" data-i18n="custom_tour_tourists_required">–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —Ç—É—Ä–∏—Å—Ç–∞</p>
                    </div>

                    <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ç—É—Ä–∞ -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4" data-i18n="custom_tour_components">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ç—É—Ä–∞</h3>
                        <p class="text-sm text-gray-600 mb-4" data-i18n="custom_tour_select_countries_hint">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—ã –≤—ã—à–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</p>
                        <div id="componentsContainer" class="space-y-6"></div>
                    </div>

                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è -->
                    <div class="border-b pb-6">
                        <label for="customerNotes" class="block text-sm font-medium text-gray-700 mb-2" data-i18n="custom_tour_notes">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>
                        <textarea id="customerNotes" name="customerNotes" rows="4"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-600 focus:border-transparent"
                            data-i18n-placeholder="custom_tour_notes_placeholder"
                            placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–∞–º –æ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö, –æ—Å–æ–±—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö..."></textarea>
                    </div>

                    <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-semibold text-gray-800" data-i18n="custom_tour_total_price">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                            <span id="totalPrice" class="text-2xl font-bold text-gray-800">0 TJS</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-2" data-i18n="custom_tour_price_note">–û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞</p>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                    <div class="pt-4">
                        <button type="submit" id="submitBtn"
                            class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                            <span id="submitText" data-i18n="custom_tour_submit_btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</span>
                            <span id="loadingText" class="hidden">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                <span data-i18n="custom_tour_submit_sending">–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...</span>
                            </span>
                        </button>
                    </div>
                </form>

                <div id="notification" class="hidden mt-6 p-4 rounded-lg"></div>
            </div>
        </div>
    </main>

    <div id="footer-container"></div>

    <script>
        let selectedCountries = [];
        let selectedCities = [];
        let tourists = [];
        let selectedComponents = [];
        let allCountries = [];
        let allCities = [];
        let allComponents = [];

        // Load countries
        async function loadCountries() {
            console.log('üîÑ loadCountries() called - fetching countries...');
            try {
                const response = await fetch('/api/countries');
                console.log('üì° Countries API response status:', response.status);
                const data = await response.json();
                console.log('üìä Countries data:', data);
                
                if (data.success) {
                    allCountries = data.data;
                    console.log('‚úÖ Loaded', allCountries.length, 'countries');
                    renderCountries();
                } else {
                    console.error('‚ùå Failed to load countries:', data);
                }
            } catch (error) {
                console.error('‚ùå Error loading countries:', error);
            }
        }

        function renderCountries() {
            const container = document.getElementById('countriesContainer');
            const lang = window.currentLanguage || 'ru';
            container.innerHTML = allCountries.map(country => {
                const countryName = lang === 'en' ? country.nameEn : country.nameRu;
                return `
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                        <input type="checkbox" value="${country.id}" 
                            onchange="toggleCountry(${country.id})"
                            class="mr-3 h-5 w-5 text-gray-600">
                        <span class="font-medium">${countryName}</span>
                    </label>
                `;
            }).join('');
        }

        async function toggleCountry(countryId) {
            const checkbox = event.target;
            
            if (checkbox.checked) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞: –∫–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∞ —Ç—Ä–µ–±—É–µ—Ç –º–∏–Ω–∏–º—É–º 3 –¥–Ω—è
                const durationInput = document.getElementById('tourDuration');
                const duration = parseInt(durationInput?.value) || 0;
                
                // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω: –º–∞–∫—Å = –¥–Ω–∏ √∑ 3 (–æ–∫—Ä—É–≥–ª—è–µ–º –≤–Ω–∏–∑)
                const maxCountries = duration > 0 ? Math.floor(duration / 3) : 0;
                
                // –ï—Å–ª–∏ –ø—ã—Ç–∞–µ–º—Å—è –≤—ã–±—Ä–∞—Ç—å –±–æ–ª—å—à–µ —Å—Ç—Ä–∞–Ω, —á–µ–º –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
                if (selectedCountries.length >= maxCountries) {
                    // –û—Ç–º–µ–Ω—è–µ–º –≤—ã–±–æ—Ä - —Å–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫—É
                    checkbox.checked = false;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç—Ä–∞–Ω
                    const warningDiv = document.getElementById('durationWarning');
                    const warningText = document.getElementById('durationWarningText');
                    if (warningDiv && warningText) {
                        if (duration === 0) {
                            warningText.textContent = getTranslation('custom_tour_specify_days_first');
                        } else {
                            const minDaysNeeded = (selectedCountries.length + 1) * 3;
                            const template = getTranslation('custom_tour_validation_warning');
                            warningText.textContent = template
                                .replace('{days}', duration)
                                .replace('{maxCountries}', maxCountries)
                                .replace('{countryWord}', getCountryWord(maxCountries))
                                .replace('{neededCountries}', selectedCountries.length + 1)
                                .replace('{neededCountryWord}', getCountryWord(selectedCountries.length + 1))
                                .replace('{minDays}', minDaysNeeded);
                        }
                        warningDiv.classList.remove('hidden');
                    }
                    
                    return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
                }
                
                selectedCountries.push(countryId);
                await loadCitiesForCountries();
                await loadComponentsForCountries();
            } else {
                selectedCountries = selectedCountries.filter(id => id !== countryId);
                // Remove cities from this country
                const countryCity = allCities.filter(c => c.countryId === countryId).map(c => c.id);
                selectedCities = selectedCities.filter(id => !countryCity.includes(id));
                await loadCitiesForCountries();
                await loadComponentsForCountries();
            }
            
            updateCitiesVisibility();
            updateTotalPrice();
            validateDuration();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–∫–ª–æ–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞ "—Å—Ç—Ä–∞–Ω–∞" / "countries"
        function getCountryWord(count) {
            const lang = window.currentLanguage || 'ru';
            
            if (lang === 'en') {
                // –í –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –ø—Ä–æ—Å—Ç–æ "country" –∏–ª–∏ "countries"
                return count === 1 ? getTranslation('custom_tour_country_1') : getTranslation('custom_tour_country_2_4');
            } else {
                // –í —Ä—É—Å—Å–∫–æ–º –µ—Å—Ç—å —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—ã
                if (count === 1) return getTranslation('custom_tour_country_1');
                if (count >= 2 && count <= 4) return getTranslation('custom_tour_country_2_4');
                return getTranslation('custom_tour_country_5plus');
            }
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞
        function getTranslation(key) {
            const lang = window.currentLanguage || 'ru';
            return window.translations && window.translations[key] && window.translations[key][lang] 
                ? window.translations[key][lang] 
                : key;
        }

        async function loadCitiesForCountries() {
            if (selectedCountries.length === 0) {
                allCities = [];
                return;
            }
            
            try {
                const response = await fetch('/api/cities');
                const data = await response.json();
                
                if (data.success) {
                    allCities = data.data.filter(city => 
                        selectedCountries.includes(city.countryId)
                    );
                    renderCities();
                }
            } catch (error) {
                console.error('Error loading cities:', error);
            }
            
            // Validate duration when countries change
            validateDuration();
        }

        // Validate tour duration based on selected countries
        function validateDuration() {
            const durationInput = document.getElementById('tourDuration');
            const warningDiv = document.getElementById('durationWarning');
            const warningText = document.getElementById('durationWarningText');
            
            if (!durationInput || !warningDiv || !warningText) return;
            
            const duration = parseInt(durationInput.value) || 0;
            const countriesCount = selectedCountries.length;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω: –º–∞–∫—Å = –¥–Ω–∏ √∑ 3 (–æ–∫—Ä—É–≥–ª—è–µ–º –≤–Ω–∏–∑)
            const maxCountries = duration > 0 ? Math.floor(duration / 3) : 0;
            
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –±–æ–ª—å—à–µ —Å—Ç—Ä–∞–Ω, —á–µ–º –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            if (countriesCount > maxCountries) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                const minDaysNeeded = countriesCount * 3;
                const template = getTranslation('custom_tour_validation_warning');
                warningText.textContent = template
                    .replace('{days}', duration)
                    .replace('{maxCountries}', maxCountries)
                    .replace('{countryWord}', getCountryWord(maxCountries))
                    .replace('{neededCountries}', countriesCount)
                    .replace('{neededCountryWord}', getCountryWord(countriesCount))
                    .replace('{minDays}', minDaysNeeded);
                warningDiv.classList.remove('hidden');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ–º –ª–∏—à–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ maxCountries —Å—Ç—Ä–∞–Ω)
                const countriesToRemove = selectedCountries.slice(maxCountries);
                selectedCountries = selectedCountries.slice(0, maxCountries);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                countriesToRemove.forEach(countryId => {
                    const checkbox = document.querySelector(`input[type="checkbox"][value="${countryId}"]`);
                    if (checkbox) checkbox.checked = false;
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–æ—Ä–æ–¥–∞ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
                loadCitiesForCountries();
                loadComponentsForCountries();
            } else {
                warningDiv.classList.add('hidden');
            }
        }

        function renderCities() {
            const container = document.getElementById('citiesContainer');
            const lang = window.currentLanguage || 'ru';
            
            if (allCities.length === 0) {
                const hint = getTranslation('custom_tour_select_cities_hint');
                container.innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">${hint}</p>`;
                return;
            }
            
            container.innerHTML = allCities.map(city => {
                const cityName = lang === 'en' ? city.nameEn : city.nameRu;
                return `
                    <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors text-sm">
                        <input type="checkbox" value="${city.id}" 
                            ${selectedCities.includes(city.id) ? 'checked' : ''}
                            onchange="toggleCity(${city.id})"
                            class="mr-2 h-4 w-4 text-gray-600">
                        <span>${cityName}</span>
                    </label>
                `;
            }).join('');
        }

        function toggleCity(cityId) {
            if (event.target.checked) {
                selectedCities.push(cityId);
            } else {
                selectedCities = selectedCities.filter(id => id !== cityId);
            }
        }

        function updateCitiesVisibility() {
            const section = document.getElementById('citiesSection');
            section.classList.toggle('hidden', selectedCountries.length === 0);
        }

        async function loadComponentsForCountries() {
            console.log('üîÑ loadComponentsForCountries() called for countries:', selectedCountries);
            if (selectedCountries.length === 0) {
                console.log('‚ö†Ô∏è No countries selected, clearing components');
                allComponents = [];
                renderComponents();
                return;
            }
            
            try {
                const promises = selectedCountries.map(countryId => {
                    console.log(`üì° Fetching components for country ${countryId}...`);
                    return fetch(`/api/custom-tour-components/country/${countryId}`).then(r => r.json());
                });
                
                const results = await Promise.all(promises);
                console.log('üìä Components API results:', results);
                allComponents = results.flatMap(r => r.success ? r.data : []);
                console.log('‚úÖ Loaded', allComponents.length, 'components');
                renderComponents();
            } catch (error) {
                console.error('‚ùå Error loading components:', error);
            }
        }

        function renderComponents() {
            const container = document.getElementById('componentsContainer');
            const lang = window.currentLanguage || 'ru';
            
            if (allComponents.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—ã, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</p>';
                return;
            }
            
            // Group by country
            const byCountry = {};
            allComponents.forEach(comp => {
                if (!byCountry[comp.countryId]) byCountry[comp.countryId] = [];
                byCountry[comp.countryId].push(comp);
            });
            
            container.innerHTML = Object.entries(byCountry).map(([countryId, components]) => {
                // Find country name from allCountries
                const country = allCountries.find(c => c.id === parseInt(countryId));
                const countryName = country 
                    ? (typeof country.name === 'object' ? country.name[lang] || country.name.ru : country.name)
                    : '–°—Ç—Ä–∞–Ω–∞';
                
                return `
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-700 mb-3 text-lg">${countryName}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${components.map(comp => {
                                const nameRu = typeof comp.name === 'object' ? comp.name.ru : comp.name;
                                const isSelected = selectedComponents.some(sc => sc.id === comp.id);
                                return `
                                    <div class="component-card border rounded-lg p-4 cursor-pointer ${isSelected ? 'selected' : ''}"
                                        onclick="toggleComponent(${comp.id})">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="font-medium text-gray-900">${nameRu}</div>
                                                <div class="text-sm text-gray-600 mt-1">${comp.price} TJS / ${comp.unit}</div>
                                            </div>
                                            <input type="checkbox" ${isSelected ? 'checked' : ''} 
                                                class="h-5 w-5 text-gray-600 pointer-events-none">
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleComponent(componentId) {
            const comp = allComponents.find(c => c.id === componentId);
            if (!comp) return;
            
            const index = selectedComponents.findIndex(sc => sc.id === componentId);
            
            if (index >= 0) {
                selectedComponents.splice(index, 1);
            } else {
                selectedComponents.push({ 
                    id: comp.id, 
                    price: comp.price, 
                    unit: comp.unit 
                });
            }
            
            renderComponents();
            updateTotalPrice();
        }


        function updateTotalPrice() {
            const touristCount = tourists.length || 1; // –ú–∏–Ω–∏–º—É–º 1 —Ç—É—Ä–∏—Å—Ç
            
            const total = selectedComponents.reduce((sum, comp) => {
                // –ï—Å–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è "–∑–∞ —á–µ–ª–æ–≤–µ–∫–∞", —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—É—Ä–∏—Å—Ç–æ–≤
                const multiplier = comp.unit === '—á–µ–ª–æ–≤–µ–∫' ? touristCount : 1;
                return sum + (comp.price * multiplier);
            }, 0);
            
            document.getElementById('totalPrice').textContent = `${total.toFixed(2)} TJS`;
        }

        function addTourist() {
            const input = document.getElementById('touristName');
            const name = input.value.trim();
            
            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ç—É—Ä–∏—Å—Ç–∞', 'error');
                return;
            }
            
            tourists.push(name);
            input.value = '';
            renderTourists();
            updateTotalPrice(); // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç—É—Ä–∏—Å—Ç–∞
        }

        function renderTourists() {
            const container = document.getElementById('touristsList');
            
            if (tourists.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">–¢—É—Ä–∏—Å—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
                return;
            }
            
            container.innerHTML = tourists.map((name, index) => `
                <div class="tourist-item flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-user text-gray-400"></i>
                        <span class="font-medium">${index + 1}. ${name}</span>
                    </div>
                    <button type="button" onclick="removeTourist(${index})" 
                        class="text-red-500 hover:text-red-700 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeTourist(index) {
            tourists.splice(index, 1);
            renderTourists();
            updateTotalPrice(); // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—É—Ä–∏—Å—Ç–∞
        }

        // Form submission
        document.getElementById('customTourForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validation
            if (selectedCountries.length === 0) {
                showNotification(getTranslation('custom_tour_error_no_countries'), 'error');
                return;
            }
            
            if (tourists.length === 0) {
                showNotification(getTranslation('custom_tour_error_no_tourists'), 'error');
                return;
            }
            
            if (selectedComponents.length === 0) {
                showNotification(getTranslation('custom_tour_error_no_components'), 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingText = document.getElementById('loadingText');
            
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            loadingText.classList.remove('hidden');
            
            try {
                // Get tour duration from manual input
                const tourDuration = parseInt(document.getElementById('tourDuration').value) || 0;
                
                // Validate duration
                if (tourDuration < 3) {
                    showNotification(getTranslation('custom_tour_error_min_days'), 'error');
                    submitBtn.disabled = false;
                    submitText.classList.remove('hidden');
                    loadingText.classList.add('hidden');
                    return;
                }
                
                const formData = {
                    fullName: document.getElementById('fullName').value.trim(),
                    email: document.getElementById('email').value.trim() || null,
                    phone: document.getElementById('phone').value.trim(),
                    selectedCountries,
                    selectedCities,
                    tourists,
                    selectedComponents,
                    customerNotes: document.getElementById('customerNotes').value.trim() || null,
                    totalPrice: parseFloat(document.getElementById('totalPrice').textContent),
                    totalDays: tourDuration
                };
                
                // DIRECT PAYMENT: Create payable order and redirect to payment
                const response = await fetch('/api/custom-tour-orders/create-payable-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(getTranslation('custom_tour_success_message'), 'success');
                    
                    // Redirect to payment page after 1 second
                    setTimeout(() => {
                        window.location.href = data.data.paymentUrl;
                    }, 1000);
                } else {
                    showNotification(data.message || getTranslation('custom_tour_error_submit'), 'error');
                }
            } catch (error) {
                console.error('Error submitting order:', error);
                showNotification(getTranslation('custom_tour_error_try_later'), 'error');
            } finally {
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                loadingText.classList.add('hidden');
            }
        });

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.className = `mt-6 p-4 rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 5000);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —è–∑—ã–∫–∞ - –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞
        document.addEventListener('languageChanged', (event) => {
            console.log('Language changed to:', event.detail.language);
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω—ã
            if (allCountries.length > 0) {
                renderCountries();
                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã
                selectedCountries.forEach(countryId => {
                    const checkbox = document.querySelector(`input[type="checkbox"][value="${countryId}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –≥–æ—Ä–æ–¥–∞
            if (allCities.length > 0) {
                renderCities();
            }
            // –û–±–Ω–æ–≤–∏—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
            updatePlaceholders();
        });

        // –û–±–Ω–æ–≤–∏—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –ø—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞
        function updatePlaceholders() {
            const elementsWithPlaceholder = document.querySelectorAll('[data-i18n-placeholder]');
            elementsWithPlaceholder.forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (key) {
                    el.placeholder = getTranslation(key);
                }
            });
        }

        // Initialize
        // Since script is at the end of body, DOM is already loaded
        // Check if DOM is ready, if so execute immediately, otherwise wait
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadCountries();
                updatePlaceholders();
            });
        } else {
            // DOM already loaded, execute immediately
            loadCountries();
            updatePlaceholders();
        }
    </script>
</body>
</html>
