<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title" data-translate="booking.page_title">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - –í—ã–±–æ—Ä –æ—Ç–µ–ª—è | Bunyod-Tour</title>
    <!-- üåê –¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ò–ù–¢–ï–†–ù–ê–¶–ò–û–ù–ê–õ–ò–ó–ê–¶–ò–ò -->
    <script src="/public/js/i18n.js"></script>
    <script src="/public/js/utils.js"></script>
    <script src="/public/js/booking-state.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .progress-step {
            transition: all 0.3s ease;
        }
        .progress-step.active {
            background: #6B7280;
            color: white;
        }
        .progress-step.completed {
            background: #10b981;
            color: white;
        }
        .hotel-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .hotel-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .room-counter {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .btn-counter {
            background: #6B7280;
            color: white;
            border: none;
            border-radius: 4px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-counter:hover {
            background: #4B5563;
        }
        .btn-counter:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .btn-counter.selected {
            background: #10b981;
        }
        .btn-counter.selected:hover {
            background: #059669;
        }
        .btn-continue {
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            width: 100%;
            transition: background 0.2s, transform 0.1s;
            border: none;
            cursor: pointer;
        }
        .btn-continue:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        .btn-continue:active {
            transform: translateY(0);
        }
        
        /* Hotel Image Slider Styles */
        .hotel-image-slider {
            position: relative;
            width: 100%;
            height: 350px;
            overflow: hidden;
            border-radius: 12px 12px 0 0;
        }
        .hotel-image-slider img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        .hotel-image-slider img.active {
            display: block;
        }
        .slider-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            z-index: 10;
        }
        .slider-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-50%) scale(1.1);
        }
        .slider-btn.prev {
            left: 15px;
        }
        .slider-btn.next {
            right: 15px;
        }
        .slider-indicators {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        .slider-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .slider-indicator.active {
            background: white;
            width: 24px;
            border-radius: 4px;
        }
        .hotel-card-content {
            padding: 24px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header Container for dynamic header -->
    <div id="header-container"></div>
    
    <!-- Progress Indicator -->
    <div class="bg-white border-b">
        <div class="max-w-6xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="progress-step active w-10 h-10 rounded-full flex items-center justify-center font-bold">1</div>
                    <span class="font-medium text-gray-700" data-translate="booking.step1.title">–í—ã–±–æ—Ä –æ—Ç–µ–ª—è</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="progress-step w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200">2</div>
                    <span class="font-medium text-gray-400" data-translate="booking.step2.title">–î–∞–Ω–Ω—ã–µ —Ç—É—Ä–∏—Å—Ç–∞</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="progress-step w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200">3</div>
                    <span class="font-medium text-gray-400" data-translate="booking.step3.title">–û–ø–ª–∞—Ç–∞</span>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Hotels List -->
            <div class="lg:col-span-3">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800" data-translate="booking.choose_hotel">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–µ–ª—å</h2>
                    <button 
                        onclick="continueWithoutHotel()" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition-colors"
                        data-translate="booking.continue_with_base_hotel">
                        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –±–∞–∑–æ–≤—ã–º –æ—Ç–µ–ª–µ–º
                    </button>
                </div>
                <div id="hotels-container" class="space-y-6">
                    <!-- Hotels will be loaded here -->
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600" data-translate="booking.loading_hotels">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–µ–ª–µ–π...</p>
                    </div>
                </div>
            </div>

            <!-- Tour Details Sidebar -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg p-6 sticky top-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4" data-translate="booking.tour_details">–î–µ—Ç–∞–ª–∏ —Ç—É—Ä–∞</h3>
                    
                    <div id="tour-details" class="space-y-4">
                        <!-- Tour details will be loaded here -->
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin text-lg text-gray-400"></i>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ REFACTORED: Use bookingStateManager instead of local state
        // Proxy object for backwards compatibility during transition
        const bookingState = {
            get bookingId() { return window.bookingStateManager.state.bookingId; },
            set bookingId(val) { window.bookingStateManager.setBookingId(val); },
            
            get tour() { return window.bookingStateManager.state.tour; },
            set tour(val) { 
                if (val) {
                    window.bookingStateManager.setTourInfo(val);
                }
            },
            
            get selectedHotel() { 
                return window.bookingStateManager.state.hotel?.id || null; 
            },
            // NOTE: selectedHotel setter removed - use setHotelInfo directly with full hotel data
            
            get roomSelection() { 
                // ‚úÖ FIXED: Return room selections directly (already in correct format)
                return window.bookingStateManager.state.selections.rooms || {};
            },
            // NOTE: roomSelection setter removed - use window.bookingStateManager.setRoomSelection() directly
            
            get mealSelection() {
                // ‚úÖ FIXED: Return meal selections directly (already in correct format)
                return window.bookingStateManager.state.selections.meals || {};
            },
            // NOTE: mealSelection setter removed - use window.bookingStateManager.setMealSelection() directly
            
            get totalPrice() { 
                return window.bookingStateManager.state.pricing.grandTotal; 
            },
            set totalPrice(val) { 
                window.bookingStateManager.state.pricing.grandTotal = val;
                window.bookingStateManager.persist();
            },
            
            get calculatedTourPrice() {
                return window.bookingStateManager.state.pricing.tourBasePrice;
            },
            set calculatedTourPrice(val) {
                window.bookingStateManager.state.pricing.tourBasePrice = val;
            },
            
            get calculatedRoomCost() {
                return window.bookingStateManager.state.pricing.roomSurcharge;
            },
            set calculatedRoomCost(val) {
                window.bookingStateManager.state.pricing.roomSurcharge = val;
            },
            
            get calculatedMealCost() {
                return window.bookingStateManager.state.pricing.mealSurcharge;
            },
            set calculatedMealCost(val) {
                window.bookingStateManager.state.pricing.mealSurcharge = val;
            },
            
            // Additional property for available hotels
            availableHotels: []
        };

        // Notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 transition-all ${
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // ‚úÖ –ö—Ä–∞—Å–∏–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É —ç–∫—Ä–∞–Ω–∞
        function showCenterModal(message, type = 'warning') {
            // –°–æ–∑–¥–∞–µ–º overlay (–∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—ã–π —Ñ–æ–Ω)
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] transition-opacity';
            overlay.style.opacity = '0';
            
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.createElement('div');
            modal.className = 'bg-white rounded-lg shadow-2xl p-5 max-w-md mx-4 transform transition-all';
            modal.style.transform = 'scale(0.9)';
            
            // –ò–∫–æ–Ω–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            const iconMap = {
                'warning': '<i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-3"></i>',
                'error': '<i class="fas fa-times-circle text-red-500 text-4xl mb-3"></i>',
                'success': '<i class="fas fa-check-circle text-green-500 text-4xl mb-3"></i>',
                'info': '<i class="fas fa-info-circle text-blue-500 text-4xl mb-3"></i>'
            };
            
            modal.innerHTML = `
                <div class="text-center">
                    ${iconMap[type] || iconMap['info']}
                    <p class="text-gray-800 text-base leading-snug">${message}</p>
                    <button 
                        onclick="this.closest('.fixed').remove()" 
                        class="bg-gray-600 hover:bg-gray-700 text-white font-medium px-6 py-2 rounded-lg transition-colors text-sm"
                        data-translate="common.ok">
                        –ü–æ–Ω—è—Ç–Ω–æ
                    </button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            requestAnimationFrame(() => {
                overlay.style.opacity = '1';
                modal.style.transform = 'scale(1)';
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.style.opacity = '0';
                    modal.style.transform = 'scale(0.9)';
                    setTimeout(() => overlay.remove(), 300);
                }
            });
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (document.body.contains(overlay)) {
                    overlay.style.opacity = '0';
                    modal.style.transform = 'scale(0.9)';
                    setTimeout(() => overlay.remove(), 300);
                }
            }, 5000);
        }

        // Currency management
        let currencyState = {
            rates: {},
            selectedCurrency: 'TJS', // Default currency
            baseCurrency: 'TJS'
        };

        // üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ priceType (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–∏—Ö –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö enum)
        function isPerPersonPricing(priceType) {
            return priceType === '–∑–∞ —á–µ–ª–æ–≤–µ–∫–∞' || priceType === 'per_person';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        async function initializePage() {
            // CRITICAL: Initialize current language from global state
            window.currentLanguage = window.currentLanguage || localStorage.getItem('selectedLanguage') || 'ru';
            console.log('üåç Booking page initialized with language:', window.currentLanguage);
            
            // Initialize currencies first
            await initializeCurrencies();

            // Get tour info from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const tourId = urlParams.get('tourId');
            const tourDate = urlParams.get('date');
            const numberOfTourists = urlParams.get('tourists');
            const bookingId = urlParams.get('bookingId'); // Check if returning from step 2

            console.log('URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:', { tourId, tourDate, numberOfTourists, bookingId });
            console.log('URL:', window.location.href);

            // If bookingId exists, load existing booking instead of creating new
            if (bookingId) {
                console.log('üìã Loading existing booking:', bookingId);
                await loadExistingBooking(bookingId);
                return;
            }

            if (!tourId || !tourDate || !numberOfTourists) {
                console.error('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:', { tourId, tourDate, numberOfTourists });
                showNotification(getTranslation('booking.error.missing_data'), 'error');
                setTimeout(() => window.location.href = '/tours-search.html', 2000);
                return;
            }

            // Start booking process
            startBooking(tourId, tourDate, numberOfTourists);
        }
        
        async function loadExistingBooking(bookingId) {
            try {
                const lang = window.currentLanguage || 'ru';
                const response = await fetch(`/api/booking/${bookingId}?lang=${lang}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìã Loaded existing booking:', data);
                
                if (data.success && data.data) {
                    const booking = data.data;
                    
                    // Restore booking state
                    window.bookingStateManager.setBookingId(booking.id);
                    window.bookingStateManager.setTourInfo({
                        id: booking.tour.id,
                        title: booking.tour.title || {},
                        currency: booking.tour.currency || 'TJS',
                        price: booking.tour.price,
                        durationDays: booking.tour.durationDays || parseInt(booking.tour.duration) || 1,
                        durationType: booking.tour.durationType || 'days',
                        tourDate: booking.tourDate
                    });
                    
                    // Restore additional tour fields
                    window.bookingStateManager.state.tour.price = booking.tour.price;
                    window.bookingStateManager.state.tour.priceType = booking.tour.priceType || '–∑–∞ —á–µ–ª–æ–≤–µ–∫–∞';
                    window.bookingStateManager.state.tour.format = booking.tour.format || booking.tour.tourType;
                    window.bookingStateManager.state.tour.tourType = booking.tour.tourType || booking.tour.format;
                    window.bookingStateManager.state.tour.services = booking.tour.services || '[]';
                    window.bookingStateManager.state.tour.duration = booking.tour.duration || booking.tour.durationDays;
                    window.bookingStateManager.state.tour.durationType = booking.tour.durationType || 'days';
                    window.bookingStateManager.persist();
                    
                    // Restore selections
                    window.bookingStateManager.setNumberOfTourists(booking.numberOfTourists);
                    window.bookingStateManager.setTourDate(booking.tourDate);
                    
                    // Restore room and meal selections
                    if (booking.roomSelection) {
                        window.bookingStateManager.setRoomSelection(booking.roomSelection);
                        console.log('‚úÖ Restored room selection:', booking.roomSelection);
                    }
                    if (booking.mealSelection) {
                        window.bookingStateManager.setMealSelection(booking.mealSelection);
                        console.log('‚úÖ Restored meal selection:', booking.mealSelection);
                    }
                    
                    // Restore hotel info if selected
                    if (booking.hotelId && booking.hotel) {
                        window.bookingStateManager.setHotelInfo({
                            id: booking.hotelId,
                            name: booking.hotel.name || {}
                        });
                    }
                    
                    // Restore pricing
                    if (booking.totalPrice) {
                        window.bookingStateManager.state.pricing.grandTotal = booking.totalPrice;
                        window.bookingStateManager.persist();
                    }
                    
                    // Display tour details
                    displayTourDetails();
                    
                    // Load hotels and restore selections
                    await loadTourHotels(booking.tour.id, booking.roomSelection, booking.mealSelection);
                    
                    // ‚úÖ Update ALL room counters after hotels are loaded and selections restored
                    console.log('üîÑ Restoring room counters after loading existing booking...');
                    updateAllRoomCounters();
                    
                    // ‚úÖ Update hotel display and room/meal display in sidebar
                    console.log('üîÑ Updating hotel and room/meal displays...');
                    updateSelectedHotelDisplay();
                    updateRoomMealDisplay();
                    
                    // ‚úÖ Update price summary AFTER hotels are loaded
                    console.log('‚úÖ Hotels loaded for existing booking, updating price summary...');
                    updatePriceSummary();
                    
                    console.log('‚úÖ Successfully loaded existing booking');
                } else {
                    throw new Error('Failed to load booking data');
                }
            } catch (error) {
                console.error('‚ùå Error loading existing booking:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                setTimeout(() => window.location.href = '/tours-search.html', 2000);
            }
        }

        // Currency functions
        async function initializeCurrencies() {
            try {
                // Get selected currency from localStorage or URL params
                const urlParams = new URLSearchParams(window.location.search);
                const currencyFromUrl = urlParams.get('currency');
                const currencyFromStorage = localStorage.getItem('selectedCurrency');
                
                currencyState.selectedCurrency = currencyFromUrl || currencyFromStorage || 'TJS';
                
                // Load exchange rates
                const response = await fetch('/api/exchange-rates');
                const data = await response.json();
                
                if (data.success) {
                    currencyState.rates = {};
                    data.data.forEach(rate => {
                        currencyState.rates[rate.currency] = {
                            rate: rate.rate,
                            symbol: rate.symbol,
                            name: rate.name
                        };
                    });
                    console.log('üí± Currency rates loaded:', currencyState.rates);
                }
            } catch (error) {
                console.error('‚ùå Error loading currencies:', error);
                // Set default rates if API fails (rate = how many TJS for 1 unit of currency)
                currencyState.rates = {
                    'TJS': { rate: 1, symbol: 'TJS', name: '–°–æ–º–æ–Ω–∏' },
                    'USD': { rate: 11.0, symbol: '$', name: '–î–æ–ª–ª–∞—Ä –°–®–ê' },
                    'EUR': { rate: 12.0, symbol: '‚Ç¨', name: '–ï–≤—Ä–æ' }
                };
            }
        }

        // Listen for currency changes from header
        window.addEventListener('currencyChanged', (event) => {
            currencyState.selectedCurrency = event.detail.currency;
            console.log('üí± Currency changed to:', currencyState.selectedCurrency);
            
            // Update all price displays
            updateAllPriceDisplays();
        });

        function updateAllPriceDisplays() {
            console.log('üí± Updating all price displays to:', currencyState.selectedCurrency);
            
            // Update complete price summary (includes all calculations)
            updatePriceSummary();
            
            // Re-render hotel cards with updated currency
            if (bookingState.availableHotels && bookingState.availableHotels.length > 0) {
                displayHotels(bookingState.availableHotels);
            }
        }

        function formatCurrencyWithEquivalent(amountTJS, showEquivalent = true) {
            const selectedCurrency = currencyState.selectedCurrency;
            const rates = currencyState.rates;
            
            // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–Ω—É –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∞–ª—é—Ç–µ
            if (selectedCurrency === 'TJS' || !rates[selectedCurrency]) {
                return `${Math.round(amountTJS)} TJS`;
            } else {
                // ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∞–ª—é—Ç—É –∏ –û–ö–†–£–ì–õ–Ø–ï–ú –¥–æ —Ü–µ–ª–æ–≥–æ (–∫–∞–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç—É—Ä–∞)
                const convertedAmount = Math.round(amountTJS / rates[selectedCurrency].rate);
                const symbol = rates[selectedCurrency].symbol;
                
                // ‚úÖ –ù–û–í–û–ï: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–Ω—É –≤ TJS –≤ —Å–∫–æ–±–∫–∞—Ö –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥—Ä—É–≥–æ–π –≤–∞–ª—é—Ç—ã
                if (showEquivalent) {
                    return `${convertedAmount} ${symbol} (${Math.round(amountTJS)} TJS)`;
                } else {
                    return `${convertedAmount} ${symbol}`;
                }
            }
        }

        async function startBooking(tourId, tourDate, numberOfTourists) {
            try {
                const requestData = {
                    tourId: parseInt(tourId),
                    tourDate,
                    numberOfTourists: parseInt(numberOfTourists)
                };
                
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:', requestData);
                
                // CRITICAL: Include language in API request
                const lang = window.currentLanguage || 'ru';
                const response = await fetch(`/api/booking/start?lang=${lang}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success && data.data) {
                    // ‚úÖ REFACTORED: Save everything to bookingStateManager (bookingState proxy will use it)
                    window.bookingStateManager.setBookingId(data.data.bookingId);
                    
                    // ‚úÖ CRITICAL: Clear old selections for fresh booking
                    window.bookingStateManager.setRoomSelection({});
                    window.bookingStateManager.setMealSelection({});
                    console.log('üßπ Cleared old selections for new booking');
                    
                    // Save tour info with ALL fields needed for display
                    const tourData = data.data.tour;
                    window.bookingStateManager.setTourInfo({
                        id: tourData.id,
                        title: tourData.title || {},
                        currency: tourData.currency || 'TJS',
                        price: tourData.price,
                        durationDays: tourData.durationDays || parseInt(tourData.duration) || 1,
                        durationType: tourData.durationType || 'days',
                        tourDate: tourDate
                    });
                    
                    // ‚úÖ FIX: Add additional tour fields WITHOUT triggering setter (to avoid losing price)
                    // Directly modify bookingStateManager.state.tour instead of using bookingState.tour setter
                    window.bookingStateManager.state.tour.price = tourData.price; // Add price field
                    window.bookingStateManager.state.tour.priceType = tourData.priceType || '–∑–∞ —á–µ–ª–æ–≤–µ–∫–∞';
                    window.bookingStateManager.state.tour.format = tourData.format || tourData.tourType;
                    window.bookingStateManager.state.tour.tourType = tourData.tourType || tourData.format;
                    window.bookingStateManager.state.tour.services = tourData.services || '[]';
                    window.bookingStateManager.persist();
                    
                    window.bookingStateManager.setNumberOfTourists(parseInt(numberOfTourists));
                    window.bookingStateManager.setTourDate(tourDate);
                    
                    // Set total price from server if available
                    if (data.data.totalPrice) {
                        window.bookingStateManager.state.pricing.grandTotal = data.data.totalPrice;
                        window.bookingStateManager.persist();
                    }
                    
                    // Display tour details
                    displayTourDetails();
                    
                    // Load hotels for this tour (wait for completion)
                    await loadTourHotels(tourId);
                    
                    // ‚úÖ Update ALL room counters after hotels are loaded (for fresh booking, counters will be 0)
                    console.log('üîÑ Initializing room counters after loading hotels...');
                    updateAllRoomCounters();
                    
                    // ‚úÖ Update hotel display and room/meal display in sidebar (will be empty for fresh booking)
                    console.log('üîÑ Updating hotel and room/meal displays...');
                    updateSelectedHotelDisplay();
                    updateRoomMealDisplay();
                    
                    // ‚úÖ Update price summary AFTER hotels are loaded
                    console.log('‚úÖ Hotels loaded, updating price summary...');
                    updatePriceSummary();
                } else {
                    throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
                }
            } catch (error) {
                console.error('‚ùå Error starting booking:', error);
                showNotification(getTranslation('booking.error.start_booking') + ': ' + error.message, 'error');
                // Redirect back to tours page on error
                setTimeout(() => {
                    window.location.href = '/tours-search.html';
                }, 2000);
            }
        }

        // Helper function to format date according to current language
        function formatDateByLanguage(dateString) {
            const locale = window.currentLanguage === 'en' ? 'en-US' : 'ru-RU';
            return new Date(dateString).toLocaleDateString(locale);
        }

        function displayTourDetails() {
            const tour = bookingState.tour;
            
            // Check if tour data is loaded
            if (!tour) {
                console.warn('displayTourDetails called before tour data loaded');
                return;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const tourDate = urlParams.get('date');
            const numberOfTourists = urlParams.get('tourists');
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–∞ - –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π –∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–º
            const lang = window.currentLanguage || 'ru';
            const tourTitle = typeof tour.title === 'object' ? (tour.title[lang] || tour.title.ru || tour.title.en) : tour.title;

            document.getElementById('tour-details').innerHTML = `
                <div class="space-y-4">
                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–µ -->
                    <div class="space-y-2">
                        <h4 class="font-medium text-gray-800 text-base">${tourTitle}</h4>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div class="flex justify-between">
                                <span data-translate="booking.tour_date">–î–∞—Ç–∞ —Ç—É—Ä–∞:</span>
                                <span class="font-medium">${formatDateByLanguage(tourDate)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span data-translate="booking.duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span>
                                <span class="font-medium">${tour.duration || tour.durationDays || 1} <span>${(tour.durationType || 'days') === 'hours' ? (lang === 'en' ? 'hrs' : '—á.') : (lang === 'en' ? 'days' : '–¥–Ω.')}</span></span>
                            </div>
                            <div class="flex justify-between">
                                <span data-translate="booking.tourists_count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—É—Ä–∏—Å—Ç–æ–≤:</span>
                                <span class="font-medium">${numberOfTourists}</span>
                            </div>
                            <div class="flex justify-between">
                                <span data-translate="booking.tour_type">–¢–∏–ø —Ç—É—Ä–∞:</span>
                                <span class="font-medium">${(() => {
                                    const tourTypeValue = tour.tourType || tour.format;
                                    if (!tourTypeValue) return getTranslation('booking.tour_type.group');
                                    if (typeof tourTypeValue === 'object') {
                                        return tourTypeValue[lang] || tourTypeValue.ru || tourTypeValue.en || getTranslation('booking.tour_type.group');
                                    }
                                    // Translate common tour type values
                                    const normalizedType = tourTypeValue.toLowerCase().replace(/\s+/g, '_');
                                    const translationKey = 'tour_type.' + normalizedType;
                                    const translated = getTranslation(translationKey);
                                    // If translation exists (not the same as key), use it, otherwise return original
                                    return translated !== translationKey ? translated : tourTypeValue;
                                })()}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
                    <div class="border-t border-gray-200"></div>
                    
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–µ–ª–µ -->
                    <div id="selected-hotel-info" class="space-y-2" style="display: none;">
                        <h5 class="font-medium text-gray-800" data-translate="booking.selected_hotel">–í—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ç–µ–ª—å</h5>
                        <div id="hotel-details-content" class="text-sm text-gray-600"></div>
                    </div>
                    
                    <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (—Å–∫—Ä—ã—Ç—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <div id="hotel-separator" class="border-t border-gray-200" style="display: none;"></div>
                    
                    <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ -->
                    <div class="border-t border-gray-200"></div>
                    
                    <!-- –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ -->
                    <div id="price-calculation" class="space-y-2">
                        <h5 class="font-medium text-gray-800" data-translate="booking.price_calculation">–†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h5>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div class="flex justify-between">
                                <span><span data-translate="booking.tour_price">–¶–µ–Ω–∞ —Ç—É—Ä–∞</span> ${isPerPersonPricing(tour.priceType) ? '√ó ' + numberOfTourists + ' <span data-translate="booking.person_short">—á–µ–ª.</span>' : '(<span data-translate="booking.per_group">–∑–∞ –≥—Ä—É–ø–ø—É</span>)'}:</span>
                                <span id="tour-price-calc" class="price-display" data-original-price="0">0 TJS</span>
                            </div>
                            <div id="room-costs-calc" class="space-y-1">
                                <!-- Room costs calculation will appear here -->
                            </div>
                            <div id="meal-costs-calc" class="space-y-1">
                                <!-- Meal costs calculation will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ -->
                    <div class="border-t border-gray-200 pt-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700" data-translate="booking.total_amount">–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞:</span>
                            <span id="sidebar-total-amount" class="text-lg font-bold text-gray-800 price-display" data-original-price="0">0 TJS</span>
                        </div>
                    </div>
                    
                    <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
                    <div class="border-t border-gray-200"></div>
                    
                    <!-- –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ -->
                    <div class="space-y-2">
                        <h5 class="font-medium text-gray-800" data-translate="booking.support_service">–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h5>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div class="flex items-center">
                                <i class="fas fa-phone text-gray-600 mr-2 w-4"></i>
                                <span>+992 935 888 000</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-envelope text-gray-600 mr-2 w-4"></i>
                                <span>info@bunyod-tour.com</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-clock text-gray-600 mr-2 w-4"></i>
                                <span data-translate="booking.working_hours">–ü–Ω-–ü—Ç: 9:00-18:00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–∞—Ö) -->
                    <div id="continue-button-container" style="display: none;">
                        <div class="border-t border-gray-200 pt-4">
                            <button onclick="proceedToStep2()" class="btn-continue">
                                <i class="fas fa-arrow-right mr-2"></i>
                                <span data-translate="booking.continue_to_step2">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</span>
                            </button>
                        </div>
                    </div>
                    
                </div>
            `;

            calculateTourPrice();
            
            // ‚úÖ –í–ê–ñ–ù–û: –í—ã–∑—ã–≤–∞–µ–º updateContinueButton() –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            // —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –º–æ–≥–ª–∞ –±—ã—Ç—å –Ω–∞–π–¥–µ–Ω–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞
            setTimeout(() => {
                updateContinueButton();
            }, 100);
        }

        function calculateTourPrice() {
            const tour = bookingState.tour;
            const urlParams = new URLSearchParams(window.location.search);
            const numberOfTourists = parseInt(urlParams.get('tourists'));
            
            // ‚úÖ FIX: Use correct price field (price or basePrice)
            let tourPrice = parseFloat(tour.price || tour.basePrice || 0);
            const tourType = tour.tourType || tour.format || '';
            
            // ‚úÖ –£–º–Ω–æ–∂–∞–µ–º –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—É—Ä–∏—Å—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ç—É—Ä–æ–≤, –µ—Å–ª–∏ priceType === '–∑–∞ —á–µ–ª–æ–≤–µ–∫–∞' –∏–ª–∏ 'per_person'
            if (isPerPersonPricing(tour.priceType)) {
                tourPrice *= numberOfTourists;
            }

            // ‚ö†Ô∏è –ù–ï –≤—ã—á–∏—Ç–∞–µ–º accommodation –∑–¥–µ—Å—å - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç updatePriceSummary()
            // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ù–ê–ß–ê–õ–¨–ù–û–ô –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ü–µ–Ω—ã

            // Safely update elements if they exist
            const tourPriceCalcElement = document.getElementById('tour-price-calc');
            if (tourPriceCalcElement) {
                tourPriceCalcElement.dataset.originalPrice = tourPrice;
                tourPriceCalcElement.textContent = formatCurrencyWithEquivalent(tourPrice);
            }
            
            const sidebarTotalElement = document.getElementById('sidebar-total-amount');
            if (sidebarTotalElement) {
                sidebarTotalElement.dataset.originalPrice = tourPrice;
                sidebarTotalElement.textContent = formatCurrencyWithEquivalent(tourPrice);
            }
            
            bookingState.totalPrice = tourPrice;
            bookingState.calculatedTourPrice = tourPrice;
            
            console.log(`üí∞ Initial tour price calculated: ${tourPrice} TJS (${numberOfTourists} tourists, type: ${tourType})`);
        }

        async function loadTourHotels(tourId, savedRoomSelection = null, savedMealSelection = null) {
            try {
                console.log('üè® Loading hotels for tour ID:', tourId);
                
                // CRITICAL: Include language in API request
                const lang = window.currentLanguage || 'ru';
                
                // üÜï Initialize bookingCityNights to avoid stale data
                window.bookingCityNights = {};
                
                // üÜï Load tour data to get nightsCount for each city
                try {
                    console.log('üìã Loading tour cities with nights count...');
                    const tourResponse = await fetch(`/api/tours/${tourId}`);
                    const tourData = await tourResponse.json();
                    
                    if (tourData.success && tourData.data.tourCities) {
                        // Store nightsCount per city in global variable
                        tourData.data.tourCities.forEach(tc => {
                            const cityId = tc.cityId || tc.city?.id;
                            // Accept 0 as valid nightsCount (check for null/undefined instead of truthiness)
                            if (cityId != null && tc.nightsCount != null) {
                                window.bookingCityNights[cityId] = tc.nightsCount;
                                console.log(`üåô City ${cityId}: ${tc.nightsCount} nights`);
                            }
                        });
                        console.log('‚úÖ City nights loaded:', window.bookingCityNights);
                    }
                } catch (tourError) {
                    console.warn('‚ö†Ô∏è Failed to load tour cities nights, using fallback:', tourError);
                    window.bookingCityNights = {};
                }
                
                // Load hotels
                const url = `/api/booking/tour/${tourId}/hotels?lang=${lang}`;
                console.log('üîó API URL:', url);
                
                const response = await fetch(url);
                console.log('üì° Response status:', response.status);
                
                const data = await response.json();
                
                if (data.success) {
                    // üÜï CRITICAL: Build hotel‚Üícity mapping BEFORE any validation occurs
                    const hotelCityMap = {};
                    data.data.forEach(hotel => {
                        const cityId = hotel.cityId || hotel.city?.id;
                        if (hotel.id && cityId) {
                            hotelCityMap[hotel.id] = String(cityId); // Ensure string for consistency
                        }
                    });
                    window.bookingStateManager.setHotelCityMap(hotelCityMap);
                    console.log('üó∫Ô∏è Hotel-City mapping preloaded:', hotelCityMap);
                    
                    displayHotels(data.data);
                    
                    // Restore room and meal selections in UI after hotels are loaded
                    if (savedRoomSelection || savedMealSelection) {
                        console.log('üîÑ Restoring selections in UI...', { savedRoomSelection, savedMealSelection });
                        setTimeout(() => {
                            restoreSelectionsInUI(savedRoomSelection, savedMealSelection);
                        }, 500); // Small delay to ensure DOM is ready
                    }
                } else {
                    console.error('‚ùå API returned error:', data.message);
                    showNotification(getTranslation('booking.error.load_hotels') + ': ' + data.message, 'error');
                }
            } catch (error) {
                console.error('‚ùå Error loading hotels:', error);
                console.error('‚ùå Error details:', error.message, error.stack);
                showNotification(getTranslation('booking.error.load_hotels_failed'), 'error');
                document.getElementById('hotels-container').innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-600" data-translate="booking.hotels_loading_error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–µ–ª–µ–π</p>
                    </div>
                `;
            }
        }
        
        function restoreSelectionsInUI(savedRoomSelection, savedMealSelection) {
            // Restore room counts in UI
            if (savedRoomSelection && typeof savedRoomSelection === 'object') {
                for (const [roomType, quantity] of Object.entries(savedRoomSelection)) {
                    const roomElements = document.querySelectorAll(`[id^="room-"][id$="-${roomType}"]`);
                    roomElements.forEach(element => {
                        if (element && quantity > 0) {
                            element.textContent = quantity;
                            console.log(`‚úÖ Restored UI for room ${roomType}: ${quantity}`);
                        }
                    });
                }
            }
            
            // Restore meal selections in UI (radio buttons)
            if (savedMealSelection && typeof savedMealSelection === 'object') {
                for (const [mealType, price] of Object.entries(savedMealSelection)) {
                    const mealRadios = document.querySelectorAll(`input[name^="meal-"][value="${mealType}"]`);
                    mealRadios.forEach(radio => {
                        if (radio) {
                            radio.checked = true;
                            console.log(`‚úÖ Restored UI for meal ${mealType}`);
                        }
                    });
                }
            }
            
            // Update price summary after restoring selections
            updatePriceSummary();
            
            // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –∏ —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ —Å—á—ë—Ç—á–∏–∫–æ–≤
            updateContinueButton();
            updateRoomCounterButtons();
            
            console.log('‚úÖ Selections restored in UI');
        }

        // Helper function to extract hotel name (string or object)
        function getHotelName(hotel) {
            if (!hotel || !hotel.name) return '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            if (typeof hotel.name === 'string') return hotel.name;
            if (typeof hotel.name === 'object') {
                const lang = window.currentLanguage || 'ru';
                return hotel.name[lang] || hotel.name.ru || hotel.name.en || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            }
            return '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        }
        
        // Helper function to extract hotel description (string or object)
        function getHotelDescription(hotel) {
            if (!hotel || !hotel.description) return '';
            if (typeof hotel.description === 'string') return hotel.description;
            if (typeof hotel.description === 'object') {
                const lang = window.currentLanguage || 'ru';
                return hotel.description[lang] || hotel.description.ru || hotel.description.en || '';
            }
            return '';
        }
        
        // Helper function to get localized room/meal name
        function getLocalizedName(item) {
            if (!item) return '';
            
            const lang = window.currentLanguage || 'ru';
            
            // Try different field names in order: name, title, categoryTitle
            const fieldNames = ['name', 'title', 'categoryTitle'];
            
            for (const fieldName of fieldNames) {
                const field = item[fieldName];
                if (!field) continue;
                
                if (typeof field === 'string') return field;
                if (typeof field === 'object') {
                    const localized = field[lang] || field.ru || field.en;
                    if (localized) return localized;
                }
            }
            
            return '';
        }

        // üÜï Helper function for Russian plural forms (1 –Ω–æ—á—å, 2 –Ω–æ—á–∏, 5 –Ω–æ—á–µ–π)
        function pluralNights(count) {
            const lang = window.currentLanguage || 'ru';
            
            if (lang === 'en') {
                return count === 1 ? 'night' : 'nights';
            }
            
            // Russian pluralization
            const mod10 = count % 10;
            const mod100 = count % 100;
            
            if (mod10 === 1 && mod100 !== 11) {
                return '–Ω–æ—á—å'; // 1 –Ω–æ—á—å, 21 –Ω–æ—á—å
            } else if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) {
                return '–Ω–æ—á–∏'; // 2 –Ω–æ—á–∏, 3 –Ω–æ—á–∏, 4 –Ω–æ—á–∏, 22 –Ω–æ—á–∏
            } else {
                return '–Ω–æ—á–µ–π'; // 5 –Ω–æ—á–µ–π, 11 –Ω–æ—á–µ–π, 100 –Ω–æ—á–µ–π
            }
        }

        function displayHotels(hotels) {
            const container = document.getElementById('hotels-container');
            
            // Store hotels in booking state for later use
            bookingState.availableHotels = [...hotels];
            
            if (hotels.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-600" data-translate="booking.no_hotels_found">–û—Ç–µ–ª–µ–π –¥–ª—è —ç—Ç–æ–≥–æ —Ç—É—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                    </div>
                `;
                return;
            }

            // ‚úÖ –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –æ—Ç–µ–ª–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º
            const hotelsByCity = new Map();
            
            hotels.forEach(hotel => {
                const cityId = hotel.cityId || hotel.city?.id || 'unknown';
                const cityName = getCityName(hotel);
                const countryName = getCountryName(hotel);
                
                if (!hotelsByCity.has(cityId)) {
                    hotelsByCity.set(cityId, {
                        cityName,
                        countryName,
                        hotels: []
                    });
                }
                
                hotelsByCity.get(cityId).hotels.push(hotel);
            });
            
            // ‚úÖ –†–µ–Ω–¥–µ—Ä–∏–º –æ—Ç–µ–ª–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –≥–æ—Ä–æ–¥–æ–≤
            let htmlContent = '';
            
            hotelsByCity.forEach((cityData, cityId) => {
                // üÜï Get nights count for this city (use nullish coalescing to accept 0)
                const cityNightsValue = window.bookingCityNights?.[cityId];
                const nightsCount = cityNightsValue ?? Math.max(1, (bookingState.tour.durationDays || 1) - 1);
                const nightsText = `${nightsCount} ${pluralNights(nightsCount)}`;
                
                htmlContent += `
                    <div class="mb-6" data-city-id="${cityId}" data-nights="${nightsCount}">
                        <div class="bg-gray-600 text-white px-6 py-4 rounded-lg shadow-md mb-4 text-center" style="background-color: #6B7280;">
                            <h3 class="text-lg font-semibold">${cityData.countryName} - ${cityData.cityName} (${nightsText})</h3>
                        </div>
                        
                        <div class="space-y-6">
                            ${cityData.hotels.map((hotel, hotelIndex) => {
                                const hotelImages = hotel.images && hotel.images.length > 0 ? hotel.images : [];
                                return `
                                <div class="hotel-card bg-white rounded-lg shadow-md overflow-hidden border border-gray-200" data-hotel-id="${hotel.id}">
                                    <!-- Hotel Image Slider -->
                                    <div class="hotel-image-slider" id="slider-${hotel.id}">
                                        ${hotelImages.length > 0 ? hotelImages.map((image, imgIndex) => `
                                            <img src="${getAbsoluteImageUrl(image)}" alt="${getHotelName(hotel)}" class="${imgIndex === 0 ? 'active' : ''}" data-index="${imgIndex}">
                                        `).join('') : `
                                            <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                                                <i class="fas fa-hotel text-6xl text-gray-400"></i>
                                            </div>
                                        `}
                                        
                                        ${hotelImages.length > 1 ? `
                                            <button class="slider-btn prev" onclick="changeSlide('${hotel.id}', -1)">
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                            <button class="slider-btn next" onclick="changeSlide('${hotel.id}', 1)">
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                            <div class="slider-indicators">
                                                ${hotelImages.map((_, indicatorIndex) => `
                                                    <div class="slider-indicator ${indicatorIndex === 0 ? 'active' : ''}" onclick="goToSlide('${hotel.id}', ${indicatorIndex})"></div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>

                                    <!-- Hotel Content -->
                                    <div class="hotel-card-content">
                                            <div class="mb-4">
                                                <h3 class="text-xl font-bold text-gray-800 mb-2">${getHotelName(hotel)}</h3>
                                                <div class="flex items-center mb-2">
                                                    ${hotel.stars ? Array(hotel.stars).fill().map(() => '<i class="fas fa-star text-yellow-400"></i>').join('') : ''}
                                                    ${hotel.rating ? `<span class="ml-2 text-sm text-gray-600">(${hotel.rating})</span>` : ''}
                                                    ${hotel.category ? `<span class="ml-2 bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-medium">${hotel.category}</span>` : ''}
                                                </div>
                                                ${hotel.address ? `
                                                    <div class="flex items-center mb-2">
                                                        <p class="text-gray-600 text-sm flex-1">
                                                            <i class="fas fa-map-marker-alt text-gray-600 mr-1"></i>${hotel.address}
                                                        </p>
                                                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(hotel.address)}" 
                                                           target="_blank" 
                                                           rel="noopener noreferrer"
                                                           class="ml-2 inline-flex items-center px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded-lg transition-colors duration-200"
                                                           title="${window.currentLanguage === 'en' ? 'Open in Google Maps' : '–û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps'}">
                                                            <i class="fas fa-map-marked-alt mr-1"></i>
                                                            ${window.currentLanguage === 'en' ? 'Map' : '–ö–∞—Ä—Ç–∞'}
                                                        </a>
                                                    </div>
                                                ` : ''}
                                                ${hotel.description ? `<p class="text-gray-600 text-sm mb-2">${getHotelDescription(hotel)}</p>` : ''}
                                            </div>

                                            <!-- Amenities -->
                                            ${hotel.amenities && hotel.amenities.length > 0 ? `
                                                <div class="mb-4">
                                                    <h4 class="font-medium text-gray-800 mb-2" data-translate="booking.amenities">–£–¥–æ–±—Å—Ç–≤–∞:</h4>
                                                    <div class="flex flex-wrap gap-2">
                                                        ${hotel.amenities.map(amenity => `
                                                            <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm">${getTranslation('amenity.' + amenity) || amenity}</span>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}

                                            <!-- Room Types -->
                                            ${(() => {
                                                let roomTypes = {};
                                                try {
                                                    roomTypes = hotel.roomTypes ? JSON.parse(hotel.roomTypes) : {};
                                                } catch (e) {
                                                    console.warn('Failed to parse roomTypes:', hotel.roomTypes);
                                                }
                                                return Object.keys(roomTypes).length > 0;
                                            })() ? `
                                                <div class="mb-4">
                                                    <h4 class="font-medium text-gray-800 mb-3">${getTranslation('booking.room_categories')}</h4>
                                                    <div class="space-y-3">
                                                        ${Object.entries((() => {
                                                            try {
                                                                return hotel.roomTypes ? JSON.parse(hotel.roomTypes) : {};
                                                            } catch (e) {
                                                                return {};
                                                            }
                                                        })()).map(([type, room]) => `
                                                            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                                                <div>
                                                                    <span class="font-medium">${type} - ${getLocalizedName(room) || type}</span>
                                                                    <span class="text-green-600 ml-2">${room.price} TJS<span data-translate="booking.per_day_short">/—Å—É—Ç–∫–∏</span></span>
                                                                </div>
                                                                <div class="room-counter flex items-center space-x-2">
                                                                    <button class="btn-counter" onclick="changeRoomQuantity('${hotel.id}', '${type}', -1)">-</button>
                                                                    <span class="w-8 text-center" id="room-${hotel.id}-${type}">0</span>
                                                                    <button class="btn-counter" onclick="changeRoomQuantity('${hotel.id}', '${type}', 1)">+</button>
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}

                                            <!-- Meal Types -->
                                            ${(() => {
                                                let mealTypes = {};
                                                try {
                                                    mealTypes = hotel.mealTypes ? JSON.parse(hotel.mealTypes) : {};
                                                } catch (e) {
                                                    console.warn('Failed to parse mealTypes:', hotel.mealTypes);
                                                }
                                                return Object.keys(mealTypes).length > 0;
                                            })() ? `
                                                <div class="mb-4">
                                                    <h4 class="font-medium text-gray-800 mb-3">${getTranslation('booking.meal_types')}</h4>
                                                    <div class="space-y-2">
                                                        ${Object.entries((() => {
                                                            try {
                                                                return hotel.mealTypes ? JSON.parse(hotel.mealTypes) : {};
                                                            } catch (e) {
                                                                return {};
                                                            }
                                                        })()).map(([type, meal]) => `
                                                            <label class="flex items-center justify-between bg-gray-50 p-3 rounded-lg cursor-pointer">
                                                                <div class="flex items-center">
                                                                    <input type="radio" name="meal-${hotel.id}" value="${type}" class="mr-3" onclick="selectMeal('${hotel.id}', '${type}', ${meal.price}, this)">
                                                                    <span class="font-medium">${type} - ${getLocalizedName(meal) || type}</span>
                                                                </div>
                                                                <span class="text-green-600">${meal.price} TJS<span data-translate="booking.per_day_short">/—Å—É—Ç–∫–∏</span></span>
                                                            </label>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                    </div>
                                </div>
                            `; }).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = htmlContent;
        }
        
        // ‚úÖ Helper function to get city name from hotel
        function getCityName(hotel) {
            const lang = window.currentLanguage || 'ru';
            
            if (hotel.city) {
                // Try localized city name first
                if (lang === 'en' && hotel.city.nameEn) return hotel.city.nameEn;
                if (lang === 'tj' && hotel.city.nameTj) return hotel.city.nameTj;
                if (hotel.city.nameRu) return hotel.city.nameRu;
                if (hotel.city.name) {
                    if (typeof hotel.city.name === 'string') return hotel.city.name;
                    if (typeof hotel.city.name === 'object') {
                        return hotel.city.name[lang] || hotel.city.name.ru || hotel.city.name.en || '';
                    }
                }
            }
            
            return lang === 'en' ? 'Unknown City' : lang === 'tj' ? '–®–∞“≥—Ä–∏ –Ω–æ–º–∞—ä–ª—É–º' : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ—Ä–æ–¥';
        }
        
        // ‚úÖ Helper function to get country name from hotel
        function getCountryName(hotel) {
            const lang = window.currentLanguage || 'ru';
            
            if (hotel.country) {
                // Try localized country name first
                if (lang === 'en' && hotel.country.nameEn) return hotel.country.nameEn;
                if (lang === 'tj' && hotel.country.nameTj) return hotel.country.nameTj;
                if (hotel.country.nameRu) return hotel.country.nameRu;
                if (hotel.country.name) {
                    if (typeof hotel.country.name === 'string') return hotel.country.name;
                    if (typeof hotel.country.name === 'object') {
                        return hotel.country.name[lang] || hotel.country.name.ru || hotel.country.name.en || '';
                    }
                }
            }
            
            return lang === 'en' ? 'Unknown Country' : lang === 'tj' ? '–ú–∞–º–ª–∞–∫–∞—Ç–∏ –Ω–æ–º–∞—ä–ª—É–º' : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞';
        }

        // Hotel Image Slider Functions
        function changeSlide(hotelId, direction) {
            const slider = document.getElementById(`slider-${hotelId}`);
            if (!slider) return;
            
            const images = slider.querySelectorAll('img');
            if (images.length <= 1) return;
            
            const currentIndex = Array.from(images).findIndex(img => img.classList.contains('active'));
            let newIndex = currentIndex + direction;
            
            // Loop around
            if (newIndex >= images.length) newIndex = 0;
            if (newIndex < 0) newIndex = images.length - 1;
            
            // Update images
            images[currentIndex].classList.remove('active');
            images[newIndex].classList.add('active');
            
            // Update indicators
            const indicators = slider.querySelectorAll('.slider-indicator');
            if (indicators.length > 0) {
                indicators[currentIndex].classList.remove('active');
                indicators[newIndex].classList.add('active');
            }
        }

        function goToSlide(hotelId, index) {
            const slider = document.getElementById(`slider-${hotelId}`);
            if (!slider) return;
            
            const images = slider.querySelectorAll('img');
            if (images.length <= 1) return;
            
            const currentIndex = Array.from(images).findIndex(img => img.classList.contains('active'));
            
            // Update images
            images[currentIndex].classList.remove('active');
            images[index].classList.add('active');
            
            // Update indicators
            const indicators = slider.querySelectorAll('.slider-indicator');
            if (indicators.length > 0) {
                indicators[currentIndex].classList.remove('active');
                indicators[index].classList.add('active');
            }
        }

        function changeRoomQuantity(hotelId, roomType, change) {
            const urlParams = new URLSearchParams(window.location.search);
            const numberOfTourists = parseInt(urlParams.get('tourists')) || 1;
            
            // ‚úÖ –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–ô –í–´–ë–û–†: –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å –Ω–æ–º–µ—Ä–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –æ—Ç–µ–ª–µ–π
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤—ã–±–æ—Ä—ã –Ω–æ–º–µ—Ä–æ–≤
            const allRoomSelections = window.bookingStateManager.state.selections.rooms || {};
            const currentHotelRooms = allRoomSelections[hotelId] || {};
            const current = currentHotelRooms[roomType] || 0;
            const newQuantity = Math.max(0, current + change);
            
            // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø –ü–û –ì–û–†–û–î–ê–ú: –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –Ω–æ–º–µ—Ä–æ–≤ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–≥–æ –≥–æ—Ä–æ–¥–∞
            const updatedHotelRooms = { ...currentHotelRooms, [roomType]: newQuantity };
            
            if (change > 0) { // –¢–æ–ª—å–∫–æ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–∞
                // üÜï CRITICAL: –ü–æ–ª—É—á–∞–µ–º cityId –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–µ–ª—è
                const cityId = getCityIdForHotel(hotelId);
                
                // üîí FAIL-CLOSED: –ë–ª–æ–∫–∏—Ä—É–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –µ—Å–ª–∏ cityId –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                if (!cityId) {
                    const lang = window.currentLanguage || 'ru';
                    const message = lang === 'en' 
                        ? `Cannot add room: hotel data unavailable.<div style="margin-top: 8px; line-height: 1.3; font-size: 0.875rem; color: #6B7280;">Please refresh the page and try again.</div>`
                        : `–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä: –¥–∞–Ω–Ω—ã–µ –æ—Ç–µ–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.<div style="margin-top: 8px; line-height: 1.3; font-size: 0.875rem; color: #6B7280;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</div>`;
                    showCenterModal(message, 'error');
                    console.error(`üîí FAIL-CLOSED: cityId not found for hotel ${hotelId}`);
                    return; // EXIT before any mutation
                }
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –¢–û–õ–¨–ö–û –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≥–æ—Ä–æ–¥–∞
                const updatedAllSelections = { ...allRoomSelections, [hotelId]: updatedHotelRooms };
                const cityCapacity = calculateRoomCapacityForCity(cityId, updatedAllSelections);
                
                if (cityCapacity > numberOfTourists) {
                    const lang = window.currentLanguage || 'ru';
                    
                    // üÜï –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –¥–ª—è –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    const citySection = document.querySelector(`[data-city-id="${cityId}"]`);
                    const cityName = citySection ? citySection.querySelector('h3')?.textContent || '' : '';
                    
                    const message = lang === 'en' 
                        ? `Cannot add more rooms for this city.<div style="margin-top: 8px; line-height: 1.3;">${cityName ? `<strong>City: ${cityName}</strong><br>` : ''}<strong>Room capacity in this city: ${cityCapacity}</strong><br><strong>Tourists: ${numberOfTourists}</strong></div><div style="font-size: 0.875rem; color: #6B7280; margin-top: 10px; margin-bottom: 20px; padding-top: 8px; border-top: 1px solid #E5E7EB; line-height: 1.4;">Capacity limit applies per city.<br>SGL = 1 person, TWN/DBL = 2 people</div>`
                        : `–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –Ω–æ–º–µ—Ä–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞.<div style="margin-top: 8px; line-height: 1.3;">${cityName ? `<strong>${cityName}</strong><br>` : ''}<strong>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –Ω–æ–º–µ—Ä–æ–≤ –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ: ${cityCapacity} —á–µ–ª.</strong><br><strong>–¢—É—Ä–∏—Å—Ç–æ–≤: ${numberOfTourists} —á–µ–ª.</strong></div><div style="font-size: 0.875rem; color: #6B7280; margin-top: 10px; margin-bottom: 20px; padding-top: 8px; border-top: 1px solid #E5E7EB; line-height: 1.4;">–õ–∏–º–∏—Ç –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –¥–µ–π—Å—Ç–≤—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Ä–æ–¥–∞.<br>SGL = 1 —á–µ–ª., TWN/DBL = 2 —á–µ–ª.</div>`;
                    showCenterModal(message, 'warning');
                    return;
                }
            }
            
            // ‚úÖ –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–ô –í–´–ë–û–†: –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–µ–ª—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –≤—ã–±–æ—Ä–∞–º –∏–∑ –¥—Ä—É–≥–∏—Ö –æ—Ç–µ–ª–µ–π
            const updatedAllRooms = { ...allRoomSelections, [hotelId]: updatedHotelRooms };
            window.bookingStateManager.setRoomSelection(updatedAllRooms);
            
            console.log(`üõèÔ∏è Room updated for hotel ${hotelId}:`, updatedHotelRooms);
            console.log(`üìä Full room structure (all hotels):`, updatedAllRooms);
            
            document.getElementById(`room-${hotelId}-${roomType}`).textContent = newQuantity;
            
            updatePriceSummary();
            
            // üéØ DEBOUNCING: –ó–∞—â–∏—Ç–∞ –æ—Ç rate limit (429 errors)
            debouncedPriceUpdate();
            
            // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –∏ —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ —Å—á—ë—Ç—á–∏–∫–æ–≤
            updateContinueButton();
            updateRoomCounterButtons();
        }
        
        // ‚úÖ –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–æ–≤ –æ–¥–Ω–æ–≥–æ –æ—Ç–µ–ª—è
        function calculateTotalRoomCapacity(rooms) {
            let totalCapacity = 0;
            const roomCapacities = {
                'SGL': 1,  // Single
                'TWN': 2,  // Twin
                'DBL': 2,  // Double  
                'TRP': 3,  // Triple
                'QUD': 4,  // Quad
            };
            
            for (const [roomType, quantity] of Object.entries(rooms)) {
                const capacity = roomCapacities[roomType] || 2;
                totalCapacity += capacity * quantity;
            }
            
            return totalCapacity;
        }
        
        // ‚úÖ –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–æ–≤ –∏–∑ –í–°–ï–• –æ—Ç–µ–ª–µ–π
        function calculateTotalRoomCapacityAllHotels(allRoomSelections) {
            let totalCapacity = 0;
            
            for (const [hotelId, rooms] of Object.entries(allRoomSelections || {})) {
                totalCapacity += calculateTotalRoomCapacity(rooms);
            }
            
            return totalCapacity;
        }
        
        // üÜï –ü–æ–ª—É—á–∏—Ç—å cityId –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ—Ç–µ–ª—è –∏–∑ persistent state
        function getCityIdForHotel(hotelId) {
            // Primary: Use persistent mapping from bookingStateManager
            const mapping = window.bookingStateManager.state.hotelCityMap || {};
            const cityId = mapping[hotelId];
            
            if (cityId) {
                return String(cityId); // Ensure string for consistency
            }
            
            // Fallback: Try DOM (for edge cases where mapping not yet populated)
            const hotelCard = document.querySelector(`[data-hotel-id="${hotelId}"]`);
            if (hotelCard) {
                const citySection = hotelCard.closest('[data-city-id]');
                if (citySection) {
                    return citySection.getAttribute('data-city-id');
                }
            }
            
            // No city ID found
            console.warn(`‚ö†Ô∏è City ID not found for hotel ${hotelId}`);
            return null;
        }
        
        // üÜï –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –Ω–æ–º–µ—Ä–æ–≤ –¢–û–õ–¨–ö–û –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
        function calculateRoomCapacityForCity(cityId, allRoomSelections) {
            let cityCapacity = 0;
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –≤—ã–±–æ—Ä–∞–º –Ω–æ–º–µ—Ä–æ–≤
            for (const [hotelId, rooms] of Object.entries(allRoomSelections || {})) {
                // –ü–æ–ª—É—á–∞–µ–º cityId –¥–ª—è —ç—Ç–æ–≥–æ –æ—Ç–µ–ª—è
                const hotelCityId = getCityIdForHotel(hotelId);
                
                // –ï—Å–ª–∏ –æ—Ç–µ–ª—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –Ω—É–∂–Ω–æ–º—É –≥–æ—Ä–æ–¥—É - –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
                if (hotelCityId === cityId) {
                    cityCapacity += calculateTotalRoomCapacity(rooms);
                }
            }
            
            return cityCapacity;
        }
        
        // ‚úÖ NEW: Debounced price update to prevent rate limiting
        let priceUpdateTimeout = null;
        function debouncedPriceUpdate() {
            if (priceUpdateTimeout) {
                clearTimeout(priceUpdateTimeout);
            }
            priceUpdateTimeout = setTimeout(() => {
                updateTotalPriceWithServerCalculation();
            }, 1000); // 1 second delay
        }

        function selectMeal(hotelId, mealType, price, radioElement) {
            // ‚úÖ FIXED: Update through bookingStateManager (radio button always replaces)
            const mealSelection = { [mealType]: price };
            window.bookingStateManager.setMealSelection(mealSelection);
            
            console.log(`‚úÖ Meal selected: ${mealType} for ${price} TJS`);
            console.log(`üçΩÔ∏è Meal updated:`, mealSelection);
            
            updatePriceSummary();
            
            // üéØ DEBOUNCING: –ó–∞—â–∏—Ç–∞ –æ—Ç rate limit (429 errors)
            debouncedPriceUpdate();
        }
        
        // ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
        function updateContinueButton() {
            const selectedRooms = window.bookingStateManager.state.selections.rooms || {};
            let hasAnyRoomsSelected = false;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤—ã–±—Ä–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –≤ –ª—é–±–æ–º –æ—Ç–µ–ª–µ
            for (const hotelId in selectedRooms) {
                const hotelRooms = selectedRooms[hotelId] || {};
                if (Object.values(hotelRooms).some(quantity => parseInt(quantity) > 0)) {
                    hasAnyRoomsSelected = true;
                    break;
                }
            }
            
            const continueButtonContainer = document.getElementById('continue-button-container');
            if (continueButtonContainer) {
                continueButtonContainer.style.display = hasAnyRoomsSelected ? 'block' : 'none';
            }
        }
        
        // ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π –∫–Ω–æ–ø–æ–∫ —Å—á—ë—Ç—á–∏–∫–æ–≤ (–∑–µ–ª—ë–Ω—ã–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ)
        function updateRoomCounterButtons() {
            const selectedRooms = window.bookingStateManager.state.selections.rooms || {};
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –æ—Ç–µ–ª—è–º –∏ –∏—Ö –Ω–æ–º–µ—Ä–∞–º
            for (const hotelId in selectedRooms) {
                const hotelRooms = selectedRooms[hotelId] || {};
                
                for (const roomType in hotelRooms) {
                    const quantity = parseInt(hotelRooms[roomType]) || 0;
                    const addButton = document.querySelector(`button[onclick*="changeRoomQuantity('${hotelId}', '${roomType}', 1)"]`);
                    
                    if (addButton) {
                        if (quantity > 0) {
                            addButton.classList.add('selected');
                        } else {
                            addButton.classList.remove('selected');
                        }
                    }
                }
            }
        }
        
        // ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –í–°–ï–• —Å—á–µ—Ç—á–∏–∫–æ–≤ –Ω–æ–º–µ—Ä–æ–≤ –∏–∑ bookingStateManager
        function updateAllRoomCounters() {
            const selectedRooms = window.bookingStateManager.state.selections.rooms || {};
            
            console.log('üîÑ Updating all room counters from state:', selectedRooms);
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –æ—Ç–µ–ª—è–º –∏ –∏—Ö –Ω–æ–º–µ—Ä–∞–º
            for (const hotelId in selectedRooms) {
                const hotelRooms = selectedRooms[hotelId] || {};
                
                for (const roomType in hotelRooms) {
                    const quantity = parseInt(hotelRooms[roomType]) || 0;
                    const counterElement = document.getElementById(`room-${hotelId}-${roomType}`);
                    
                    if (counterElement) {
                        counterElement.textContent = quantity;
                        console.log(`‚úÖ Updated counter room-${hotelId}-${roomType} to ${quantity}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Counter element not found: room-${hotelId}-${roomType}`);
                    }
                }
            }
        }
        
        // ‚úÖ –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –≤—Ç–æ—Ä–æ–π —ç—Ç–∞–ø –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        async function proceedToStep2() {
            const selectedRooms = window.bookingStateManager.state.selections.rooms || {};
            let hasAnyRoomsSelected = false;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤—ã–±—Ä–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä
            for (const hotelId in selectedRooms) {
                const hotelRooms = selectedRooms[hotelId] || {};
                if (Object.values(hotelRooms).some(quantity => parseInt(quantity) > 0)) {
                    hasAnyRoomsSelected = true;
                    break;
                }
            }
            
            if (!hasAnyRoomsSelected) {
                showNotification(getTranslation('booking.error.select_room'), 'warning');
                return;
            }
            
            // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–æ–º–µ—Ä–∞, –ø–∏—Ç–∞–Ω–∏–µ, –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É) –≤ –ë–î
            await saveBookingDraft();
            // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: saveBookingDraft() —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ step2
        }

        function selectHotel(hotelId) {
            // ‚úÖ FIXED: Check rooms from bookingStateManager with correct structure
            const selectedRooms = window.bookingStateManager.state.selections.rooms || {};
            
            // Check if there are any rooms selected for THIS hotel with quantity > 0
            const hotelRooms = selectedRooms[hotelId] || {};
            const hasRoomsSelected = Object.values(hotelRooms).some(quantity => parseInt(quantity) > 0);
            
            console.log('üîç selectHotel validation:', {
                hotelId,
                hotelRooms,
                hasRoomsSelected
            });
            
            if (!hasRoomsSelected) {
                showNotification(getTranslation('booking.error.select_room'), 'warning');
                return;
            }
            
            // ‚úÖ Set hotel info in bookingStateManager
            const hotelData = bookingState.availableHotels.find(h => h.id == hotelId);
            if (hotelData) {
                window.bookingStateManager.setHotelInfo({
                    id: hotelData.id,
                    name: hotelData.name || {}
                });
            }
            
            // Highlight selected hotel
            document.querySelectorAll('.hotel-card').forEach(card => {
                card.classList.remove('ring-2', 'ring-gray-500');
            });
            document.querySelector(`[data-hotel-id="${hotelId}"]`).classList.add('ring-2', 'ring-gray-500');
            
            // Update hotel details in sidebar
            updateSelectedHotelDetails(hotelId);
            
            // Save booking draft and proceed to next step
            saveBookingDraft();
        }
        
        function updateSelectedHotelDetails(hotelId) {
            const hotelData = bookingState.availableHotels.find(h => h.id == hotelId);
            if (!hotelData) return;
            
            const hotelInfoSection = document.getElementById('selected-hotel-info');
            const hotelSeparator = document.getElementById('hotel-separator');
            const hotelDetailsContent = document.getElementById('hotel-details-content');
            
            // Show hotel info section
            hotelInfoSection.style.display = 'block';
            hotelSeparator.style.display = 'block';
            
            // Generate stars display
            const starsHtml = hotelData.stars ? 
                Array.from({length: hotelData.stars}, () => '‚≠ê').join('') : 
                '–ë–µ–∑ —Ä–µ–π—Ç–∏–Ω–≥–∞';
            
            hotelDetailsContent.innerHTML = `
                <div class="space-y-1">
                    <div class="font-medium text-gray-800">${getHotelName(hotelData)}</div>
                    <div class="flex items-center gap-1">
                        <span class="text-yellow-500">${starsHtml}</span>
                        ${hotelData.stars ? `<span class="text-xs text-gray-500">(${hotelData.stars} <span data-translate="booking.stars">${hotelData.stars > 4 ? '–∑–≤–µ–∑–¥' : hotelData.stars > 1 ? '–∑–≤–µ–∑–¥—ã' : '–∑–≤–µ–∑–¥–∞'}</span>)</span>` : ''}
                    </div>
                    <div class="flex items-start gap-1">
                        <i class="fas fa-map-marker-alt text-gray-400 mt-0.5"></i>
                        <span>${hotelData.address || '<span data-translate="booking.no_address">–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω</span>'}</span>
                    </div>
                </div>
            `;
        }
        
        function updateRoomMealDetails() {
            const roomDetailsContent = document.getElementById('room-details-content');
            const mealDetailsContent = document.getElementById('meal-details-content');
            const roomMealInfo = document.getElementById('room-meal-info');
            const capacityInfo = document.getElementById('capacity-info');
            
            if (!bookingState.selectedHotel || !roomDetailsContent) return;
            
            const hotelData = bookingState.availableHotels.find(h => h.id == bookingState.selectedHotel);
            if (!hotelData) return;
            
            // Parse room types
            let roomTypes = {};
            try {
                roomTypes = typeof hotelData.roomTypes === 'string' ? JSON.parse(hotelData.roomTypes) : (hotelData.roomTypes || {});
            } catch (e) {
                console.warn('Failed to parse room types:', hotelData.roomTypes);
                roomTypes = {};
            }
            
            // Parse meal types
            let mealTypes = {};
            try {
                mealTypes = typeof hotelData.mealTypes === 'string' ? JSON.parse(hotelData.mealTypes) : (hotelData.mealTypes || {});
            } catch (e) {
                console.warn('Failed to parse meal types:', hotelData.mealTypes);
                mealTypes = {};
            }
            
            // Check if any rooms are selected
            const selectedRooms = bookingState.roomSelection[bookingState.selectedHotel] || {};
            const hasSelectedRooms = Object.values(selectedRooms).some(quantity => quantity > 0);
            
            // Check if any meals are selected  
            const selectedMeals = bookingState.mealSelection[bookingState.selectedHotel] || {};
            const hasSelectedMeals = Object.keys(selectedMeals).length > 0;
            
            if (!hasSelectedRooms && !hasSelectedMeals) {
                roomMealInfo.style.display = 'none';
                return;
            }
            
            roomMealInfo.style.display = 'block';
            
            // Display selected rooms - —á–∏—Å—Ç—ã–π –∏ –∫—Ä–∞—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç
            let roomsHtml = '';
            let totalCapacity = 0;
            const urlParams = new URLSearchParams(window.location.search);
            const numberOfTourists = parseInt(urlParams.get('tourists')) || 1;
            
            if (hasSelectedRooms) {
                for (const [roomType, quantity] of Object.entries(selectedRooms)) {
                    if (quantity > 0 && roomTypes[roomType]) {
                        const roomInfo = roomTypes[roomType];
                        const roomCapacity = getRoomCapacity(roomType);
                        totalCapacity += roomCapacity * quantity;
                        
                        // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
                        const roomName = getLocalizedName(roomInfo) || roomType;
                        
                        roomsHtml += `
                            <div class="flex justify-between items-center text-sm">
                                <span>${roomName} √ó ${quantity}</span>
                                <span class="text-gray-600">${Math.round(roomInfo.price)} TJS/<span data-translate="booking.per_day_short">—Å—É—Ç</span></span>
                            </div>
                        `;
                    }
                }
            }
            
            roomDetailsContent.innerHTML = roomsHtml || '<div class="text-gray-500 text-xs" data-translate="booking.no_rooms_selected">–ù–æ–º–µ—Ä–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>';
            
            // Display selected meals - —á–∏—Å—Ç—ã–π –∏ –∫—Ä–∞—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç
            let mealsHtml = '';
            if (hasSelectedMeals) {
                for (const [mealType, price] of Object.entries(selectedMeals)) {
                    if (mealTypes[mealType]) {
                        const mealInfo = mealTypes[mealType];
                        const mealName = getLocalizedName(mealInfo) || mealType;
                        mealsHtml += `
                            <div class="flex justify-between items-center text-sm">
                                <span>${mealName}</span>
                                <span class="text-gray-600">${Math.round(price)} TJS/<span data-translate="booking.per_day_short">—Å—É—Ç</span></span>
                            </div>
                        `;
                    }
                }
            }
            
            mealDetailsContent.innerHTML = mealsHtml || '';
            
            // Display capacity info - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–º–Ω–∞—Ç—ã
            if (hasSelectedRooms && totalCapacity > 0) {
                const capacityOk = totalCapacity >= numberOfTourists;
                capacityInfo.innerHTML = `
                    <div class="text-xs ${capacityOk ? 'text-green-600' : 'text-red-600'}">
                        <span data-translate="booking.total_capacity">–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</span>: ${totalCapacity} <span data-translate="booking.person_short">—á–µ–ª</span> (<span data-translate="booking.required">—Ç—Ä–µ–±—É–µ—Ç—Å—è</span>: ${numberOfTourists})
                    </div>
                `;
            } else {
                capacityInfo.innerHTML = '';
            }
        }
        
        function getRoomCapacity(roomType) {
            // Standard room capacity based on room type
            const capacities = {
                'SGL': 1,  // Single
                'TWN': 2,  // Twin
                'DBL': 2,  // Double  
                'TRP': 3,  // Triple
                'QUD': 4,  // Quad
            };
            return capacities[roomType] || 2; // Default 2 people
        }

        function updatePriceSummary() {
            const tour = bookingState.tour;
            const urlParams = new URLSearchParams(window.location.search);
            const numberOfTourists = parseInt(urlParams.get('tourists')) || window.bookingStateManager?.state?.selections?.numberOfTourists || 1;
            
            console.log('üîç DEBUG tour.duration:', tour.duration, 'type:', typeof tour.duration);
            console.log('üîç DEBUG tour.durationDays:', tour.durationDays, 'type:', typeof tour.durationDays);
            
            const tourDuration = parseInt(tour.durationDays) || parseInt(tour.duration) || 1;
            
            console.log('‚úÖ FINAL tourDuration:', tourDuration);
            
            const roomCostsCalc = document.getElementById('room-costs-calc');
            const mealCostsCalc = document.getElementById('meal-costs-calc');
            
            let totalRoomCost = 0;
            let totalMealCost = 0;
            let accommodationDeduction = 0;
            
            // Calculate base tour price
            let baseTourPrice = parseFloat(tour.price || tour.basePrice || 0);
            
            // ‚úÖ –£–º–Ω–æ–∂–∞–µ–º –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—É—Ä–∏—Å—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ç—É—Ä–æ–≤, –µ—Å–ª–∏ priceType === '–∑–∞ —á–µ–ª–æ–≤–µ–∫–∞' –∏–ª–∏ 'per_person'
            if (isPerPersonPricing(tour.priceType)) {
                baseTourPrice *= numberOfTourists;
            }
            
            // Update hotel information display first
            updateSelectedHotelDisplay();
            
            // Clear calculation areas
            if (roomCostsCalc) roomCostsCalc.innerHTML = '';
            if (mealCostsCalc) mealCostsCalc.innerHTML = '';
            
            // üè® Calculate accommodation deduction if rooms are selected
            // ‚úÖ FIX: Use bookingStateManager as source of truth instead of bookingState
            const selectedRooms = window.bookingStateManager?.state?.selections?.rooms || bookingState.roomSelection || {};
            const hasSelectedRooms = Object.values(selectedRooms).some(rooms => 
                Object.values(rooms).some(quantity => quantity > 0)
            );
            
            console.log('üîç Checking accommodation deduction:', {
                hasSelectedRooms,
                selectedRooms,
                tourServices: !!tour.services
            });
            
            if (hasSelectedRooms && tour.services) {
                try {
                    // ‚úÖ FIX: tour.services –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ –æ–±—ä–µ–∫—Ç–æ–º –∏–ª–∏ —Å—Ç—Ä–æ–∫–æ–π
                    let services = tour.services;
                    if (typeof services === 'string') {
                        services = JSON.parse(services);
                    }
                    
                    console.log('üîç Parsed services for accommodation deduction:', services);
                    
                    const accommodationService = services.find(service => 
                        service && service.key && (
                            service.key === 'accommodation_std' ||
                            service.key.includes('accommodation') ||
                            service.key.includes('—Ö–æ—Å—Ç–µ–ª') ||
                            service.key.includes('–≥–æ—Å—Ç–∏–Ω–∏—Ü–∞') ||
                            (service.name && service.name.toLowerCase().includes('–ø—Ä–æ–∂–∏–≤–∞–Ω'))
                        )
                    );
                    
                    console.log('üè® Found accommodation service:', accommodationService);
                    
                    if (accommodationService && accommodationService.price) {
                        const accommodationPrice = parseFloat(accommodationService.price);
                        
                        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è —É–∂–µ –≤–∫–ª—é—á–µ–Ω –≤ –±–∞–∑–æ–≤—É—é —Ü–µ–Ω—É —Ç—É—Ä–∞ –∑–∞ –≤–µ—Å—å —Ç—É—Ä
                        // –í—ã—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –ë–ï–ó —É–º–Ω–æ–∂–µ–Ω–∏—è –Ω–∞ –¥–Ω–∏
                        // ‚úÖ –£–º–Ω–æ–∂–∞–µ–º –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—É—Ä–∏—Å—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ç—É—Ä–æ–≤, –µ—Å–ª–∏ priceType === '–∑–∞ —á–µ–ª–æ–≤–µ–∫–∞' –∏–ª–∏ 'per_person'
                        if (isPerPersonPricing(tour.priceType)) {
                            accommodationDeduction = accommodationPrice * numberOfTourists;
                        } else {
                            accommodationDeduction = accommodationPrice;
                        }
                        
                        console.log('üí∞ Calculated accommodation deduction:', accommodationDeduction);
                        
                        // Show accommodation deduction in price calculation
                        if (roomCostsCalc && accommodationDeduction > 0) {
                            roomCostsCalc.innerHTML += `
                                <div class="flex justify-between text-sm text-red-600">
                                    <span><span data-translate="booking.accommodation_deduction">–í—ã—á–µ—Ç –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è</span>:</span>
                                    <span>-${formatCurrencyWithEquivalent(accommodationDeduction)}</span>
                                </div>
                            `;
                        }
                    }
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —É—Å–ª—É–≥–∏ —Ç—É—Ä–∞:', e);
                }
            }
            
            // ‚úÖ Calculate room costs for ALL hotels (multiple hotel selection support)
            console.log('üîç Room calculation check:', {
                hasRoomSelection: !!bookingState.roomSelection,
                roomSelectionKeys: Object.keys(bookingState.roomSelection || {}),
                roomSelectionData: bookingState.roomSelection
            });
            
            // Loop through all hotels that have room selections
            for (const [hotelId, rooms] of Object.entries(bookingState.roomSelection || {})) {
                // Skip if no rooms selected for this hotel
                if (!rooms || Object.values(rooms).every(qty => qty === 0)) continue;
                
                console.log('üè® Processing rooms for hotel:', hotelId, 'Rooms:', rooms);
                
                // Find hotel data from bookingState
                const hotelData = bookingState.availableHotels?.find(h => h.id == hotelId);
                console.log('üè® Hotel data found:', !!hotelData, hotelData ? `(${getHotelName(hotelData)})` : '(null)');
                
                if (hotelData) {
                    // Parse room types to get real price
                    let roomTypes = {};
                    try {
                        roomTypes = typeof hotelData.roomTypes === 'string' ? JSON.parse(hotelData.roomTypes) : (hotelData.roomTypes || {});
                    } catch (e) {
                        console.warn('Failed to parse room types for pricing:', hotelData.roomTypes);
                        roomTypes = {};
                    }
                    
                    console.log('üè® Room types available:', Object.keys(roomTypes));
                    
                    // üÜï Get nights count for this hotel's city (use nullish coalescing to accept 0)
                    const cityId = hotelData.cityId || hotelData.city?.id;
                    const cityNightsValue = window.bookingCityNights?.[cityId];
                    const cityNights = cityNightsValue ?? Math.max(1, tourDuration - 1);
                    
                    console.log(`üåô Hotel ${hotelId} in city ${cityId}: ${cityNights} nights`);
                    
                    for (const [roomType, quantity] of Object.entries(rooms)) {
                        console.log(`üîç Checking room: ${roomType}, quantity: ${quantity}, has price: ${!!roomTypes[roomType]}`);
                        
                        if (quantity > 0 && roomTypes[roomType]) {
                            const roomPrice = parseFloat(roomTypes[roomType].price) || 0;
                            const roomCost = roomPrice * quantity * cityNights;
                            totalRoomCost += roomCost;
                            
                            console.log(`‚úÖ Room calculation: Hotel ${hotelId}, ${roomType} = ${roomPrice} √ó ${quantity} √ó ${cityNights} –Ω–æ—á–µ–π = ${roomCost} TJS`);
                            
                            if (roomCostsCalc) {
                                // Get localized room name
                                const roomName = getLocalizedName(roomTypes[roomType]) || roomType;
                                const hotelName = getHotelName(hotelData);
                                
                                roomCostsCalc.innerHTML += `
                                    <div class="flex justify-between text-sm">
                                        <span>${hotelName}: ${roomName} √ó ${quantity} √ó ${cityNights} <span data-translate="booking.nights_short">–Ω–æ—á.</span>:</span>
                                        <span>${formatCurrencyWithEquivalent(roomCost)}</span>
                                    </div>
                                `;
                            }
                        } else {
                            console.warn(`‚ö†Ô∏è Skipped room ${roomType}: quantity=${quantity}, hasPrice=${!!roomTypes[roomType]}`);
                        }
                    }
                } else {
                    console.error('‚ùå Hotel data NOT found for ID:', hotelId, 'Available hotels:', bookingState.availableHotels?.map(h => h.id));
                }
            }
            
            // ‚úÖ Calculate meal costs for ALL hotels (multiple hotel selection support)
            for (const [hotelId, meals] of Object.entries(bookingState.mealSelection || {})) {
                // Skip if no meals selected for this hotel
                if (!meals || Object.keys(meals).length === 0) continue;
                
                // Find hotel data to check if meals are included in room
                const hotelData = bookingState.availableHotels.find(h => h.id == hotelId);
                let mealTypes = {};
                
                if (hotelData) {
                    try {
                        mealTypes = typeof hotelData.mealTypes === 'string' ? JSON.parse(hotelData.mealTypes) : (hotelData.mealTypes || {});
                    } catch (e) {
                        console.warn('Failed to parse meal types for pricing:', hotelData.mealTypes);
                        mealTypes = {};
                    }
                }
                
                // üÜï Get nights count for this hotel's city (use nullish coalescing to accept 0)
                const cityId = hotelData?.cityId || hotelData?.city?.id;
                const cityNightsValue = window.bookingCityNights?.[cityId];
                const cityNights = cityNightsValue ?? Math.max(1, tourDuration - 1);
                
                for (const [mealType, price] of Object.entries(meals)) {
                    // Check if meal is included in any selected room type
                    const isMealIncludedInRoom = checkIfMealIncludedInRoom(hotelId, mealType);
                    
                    if (!isMealIncludedInRoom) {
                        const mealCost = price * numberOfTourists * cityNights;
                        totalMealCost += mealCost;
                        
                        console.log(`üçΩÔ∏è Meal calculation: Hotel ${hotelId}, ${mealType} = ${price} √ó ${numberOfTourists} √ó ${cityNights} –Ω–æ—á–µ–π = ${mealCost} TJS`);
                        
                        // Get localized meal name
                        const mealName = getLocalizedName(mealTypes[mealType]) || mealType;
                        const hotelName = hotelData ? getHotelName(hotelData) : `Hotel ${hotelId}`;
                        
                        if (mealCostsCalc) {
                            mealCostsCalc.innerHTML += `
                                <div class="flex justify-between text-sm">
                                    <span>${hotelName}: ${mealName} √ó ${numberOfTourists} √ó ${nightsCount} <span data-translate="booking.nights_short">–Ω–æ—á.</span>:</span>
                                    <span>${formatCurrencyWithEquivalent(mealCost)}</span>
                                </div>
                            `;
                        }
                    } else {
                        // Show that meal is included - get localized meal name
                        const mealName = getLocalizedName(mealTypes[mealType]) || mealType;
                        const hotelName = hotelData ? getHotelName(hotelData) : `Hotel ${hotelId}`;
                        
                        if (mealCostsCalc) {
                            mealCostsCalc.innerHTML += `
                                <div class="flex justify-between text-sm text-green-600">
                                    <span>${hotelName}: ${mealName} (<span data-translate="booking.included_in_room">–≤–∫–ª—é—á–µ–Ω–æ</span>):</span>
                                    <span>${formatCurrencyWithEquivalent(0)}</span>
                                </div>
                            `;
                        }
                    }
                }
            }
            
            // Calculate final tour price: base - accommodation + rooms + meals
            const finalTourPrice = baseTourPrice - accommodationDeduction + totalRoomCost + totalMealCost;
            
            // Update tour price display (shows base price minus accommodation)
            const tourPriceCalcElement = document.getElementById('tour-price-calc');
            if (tourPriceCalcElement) {
                // Show base tour price (will be adjusted by accommodation deduction shown separately)
                tourPriceCalcElement.dataset.originalPrice = baseTourPrice;
                tourPriceCalcElement.textContent = formatCurrencyWithEquivalent(baseTourPrice);
            }
            
            // Update total price
            const sidebarTotalElement = document.getElementById('sidebar-total-amount');
            if (sidebarTotalElement) {
                sidebarTotalElement.dataset.originalPrice = finalTourPrice;
                sidebarTotalElement.textContent = formatCurrencyWithEquivalent(finalTourPrice);
            }
            
            // Store calculated costs for state
            bookingState.calculatedRoomCost = totalRoomCost;
            bookingState.calculatedMealCost = totalMealCost;
            bookingState.calculatedTourPrice = baseTourPrice - accommodationDeduction;
            bookingState.totalPrice = finalTourPrice;
            
            console.log('üí∞ Price summary updated:', {
                baseTourPrice,
                accommodationDeduction,
                totalRoomCost,
                totalMealCost,
                finalTourPrice
            });
        }
        
        function updateSelectedHotelDisplay() {
            const selectedHotelInfo = document.getElementById('selected-hotel-info');
            const hotelDetailsContent = document.getElementById('hotel-details-content');
            const hotelSeparator = document.getElementById('hotel-separator');
            
            if (!selectedHotelInfo || !hotelDetailsContent) return;
            
            // ‚úÖ FIX: Get ALL hotels with selected rooms, not just one
            const selectedRooms = bookingState.roomSelection || {};
            const hotelsWithRooms = [];
            
            // Find all hotels that have selected rooms
            for (const [hotelId, rooms] of Object.entries(selectedRooms)) {
                const hasRooms = Object.values(rooms).some(qty => qty > 0);
                if (hasRooms) {
                    const hotelData = bookingState.availableHotels?.find(h => h.id == hotelId);
                    if (hotelData) {
                        hotelsWithRooms.push(hotelData);
                    }
                }
            }
            
            // If no hotels with rooms, hide the section
            if (hotelsWithRooms.length === 0) {
                selectedHotelInfo.style.display = 'none';
                if (hotelSeparator) hotelSeparator.style.display = 'none';
                return;
            }
            
            // Show hotel information section
            selectedHotelInfo.style.display = 'block';
            if (hotelSeparator) hotelSeparator.style.display = 'block';
            
            // ‚úÖ Display ALL hotels with selected rooms
            let hotelsHtml = '';
            hotelsWithRooms.forEach((hotelData, index) => {
                const starsDisplay = hotelData.stars ? '‚òÖ'.repeat(hotelData.stars) : '';
                const marginClass = index > 0 ? 'mt-3 pt-3 border-t border-gray-200' : '';
                
                hotelsHtml += `
                    <div class="space-y-1 ${marginClass}">
                        <div class="font-medium">${getHotelName(hotelData)}</div>
                        <div class="text-xs text-gray-500">${hotelData.address || ''}</div>
                        ${starsDisplay ? `<div class="text-yellow-500 text-sm">${starsDisplay}</div>` : ''}
                    </div>
                `;
            });
            
            hotelDetailsContent.innerHTML = hotelsHtml;
            
            console.log(`‚úÖ Displaying ${hotelsWithRooms.length} hotel(s) with selected rooms`);
        }

        function updateRoomMealDisplay() {
            const roomMealInfo = document.getElementById('room-meal-info');
            const roomDetailsContent = document.getElementById('room-details-content');
            const mealDetailsContent = document.getElementById('meal-details-content');
            const capacityInfo = document.getElementById('capacity-info');
            
            if (!roomMealInfo || !roomDetailsContent) return;
            
            // Check if there are any selected rooms
            const hasSelectedRooms = Object.values(bookingState.roomSelection).some(rooms => 
                Object.values(rooms).some(quantity => quantity > 0)
            );
            
            if (!hasSelectedRooms) {
                roomMealInfo.style.display = 'none';
                return;
            }
            
            roomMealInfo.style.display = 'block';
            
            // Display selected rooms
            let roomsHtml = '';
            let totalCapacity = 0;
            
            for (const [hotelId, rooms] of Object.entries(bookingState.roomSelection)) {
                for (const [roomType, quantity] of Object.entries(rooms)) {
                    if (quantity > 0) {
                        const hotelData = bookingState.availableHotels.find(h => h.id == hotelId);
                        if (hotelData) {
                            let roomTypes = {};
                            try {
                                roomTypes = typeof hotelData.roomTypes === 'string' ? JSON.parse(hotelData.roomTypes) : (hotelData.roomTypes || {});
                            } catch (e) {
                                roomTypes = {};
                            }
                            
                            if (roomTypes[roomType]) {
                                const roomCapacity = getRoomCapacity(roomType);
                                const totalRoomCapacity = roomCapacity * quantity;
                                totalCapacity += totalRoomCapacity;
                                
                                const roomName = getLocalizedName(roomTypes[roomType]) || roomType;
                                roomsHtml += `
                                    <div class="flex justify-between">
                                        <span>${roomName} √ó ${quantity}</span>
                                        <span>${Math.round(roomTypes[roomType].price)} TJS/—Å—É—Ç–∫–∏</span>
                                    </div>
                                `;
                            }
                        }
                    }
                }
            }
            
            roomDetailsContent.innerHTML = roomsHtml;
            
            // Display capacity info
            const urlParams = new URLSearchParams(window.location.search);
            const numberOfTourists = parseInt(urlParams.get('tourists'));
            
            if (capacityInfo) {
                const capacityColor = totalCapacity >= numberOfTourists ? 'text-green-600' : 'text-red-600';
                capacityInfo.innerHTML = `
                    <div class="${capacityColor}">
                        <span data-translate="booking.total_capacity">–û–±—â–∞—è –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:</span> ${totalCapacity} <span data-translate="booking.person_short">—á–µ–ª.</span> (<span data-translate="booking.required">—Ç—Ä–µ–±—É–µ—Ç—Å—è:</span> ${numberOfTourists} <span data-translate="booking.person_short">—á–µ–ª.</span>)
                    </div>
                `;
            }
            
            // Display meal selection if any
            let mealsHtml = '';
            for (const [hotelId, meals] of Object.entries(bookingState.mealSelection)) {
                const hotelData = bookingState.availableHotels.find(h => h.id == hotelId);
                if (hotelData) {
                    let mealTypes = {};
                    try {
                        mealTypes = typeof hotelData.mealTypes === 'string' ? JSON.parse(hotelData.mealTypes) : (hotelData.mealTypes || {});
                    } catch (e) {
                        mealTypes = {};
                    }
                    
                    for (const [mealType, price] of Object.entries(meals)) {
                        if (mealTypes[mealType]) {
                            const mealName = getLocalizedName(mealTypes[mealType]) || mealType;
                            const mealLabel = getTranslation('booking.meal') || '–ü–∏—Ç–∞–Ω–∏–µ';
                            mealsHtml += `
                                <div class="flex justify-between text-xs">
                                    <span>${mealLabel}: ${mealName}</span>
                                    <span class="text-green-600 font-medium">${Math.round(price)} TJS/—Å—É—Ç–∫–∏</span>
                                </div>
                            `;
                        }
                    }
                }
            }
            
            if (mealDetailsContent) {
                mealDetailsContent.innerHTML = mealsHtml;
            }
        }

        function checkIfMealIncludedInRoom(hotelId, mealType) {
            // TODO: This would check if the selected room type includes this meal type
            // For now, assume no meals are included unless specified
            // In a real implementation, this would check room type properties
            return false;
        }

        function updateTotalPrice() {
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É: –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —Ç—É—Ä–∞ + –Ω–æ–º–µ—Ä–∞ + –ø–∏—Ç–∞–Ω–∏–µ
            const tourPrice = bookingState.calculatedTourPrice || 0;
            const roomCost = bookingState.calculatedRoomCost || 0;
            const mealCost = bookingState.calculatedMealCost || 0;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
            const totalPrice = tourPrice + roomCost + mealCost;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            bookingState.totalPrice = totalPrice;
            
            // Update total price in sidebar
            const sidebarTotalElement = document.getElementById('sidebar-total-amount');
            if (sidebarTotalElement) {
                sidebarTotalElement.dataset.originalPrice = totalPrice;
                sidebarTotalElement.textContent = formatCurrencyWithEquivalent(totalPrice);
            }
            
            console.log('üí∞ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞:', {
                tourPrice,
                roomCost,
                mealCost,
                totalPrice
            });
        }

        // üéØ –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–æ–≤–ª—è–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ –±–∞–∑–æ–≤–æ–π —Ü–µ–Ω–µ
        async function updateTotalPriceWithServerCalculation() {
            // –ù—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ bookingId –¥–ª—è —Ä–∞–±–æ—Ç—ã
            if (!bookingState.bookingId || !bookingState.availableHotels) {
                return;
            }

            // ‚úÖ CRITICAL FIX: Use bookingStateManager directly
            const targetHotelId = window.bookingStateManager.state.hotel?.id;
            const rooms = window.bookingStateManager.state.selections.rooms || {};
            const hasAnySelectedRooms = Object.values(rooms).some(quantity => quantity > 0);
            let roomSelectionForAPI = {};
            
            if (hasAnySelectedRooms && targetHotelId) {
                console.log(`üè® Using hotel ${targetHotelId} with rooms:`, rooms);
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è API
                for (const [roomType, quantity] of Object.entries(rooms)) {
                    if (quantity > 0) {
                        // –ù–∞–π—Ç–∏ —Ü–µ–Ω—É –∫–æ–º–Ω–∞—Ç—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–µ–ª—è
                        const hotelData = bookingState.availableHotels.find(h => h.id == targetHotelId);
                        if (hotelData && hotelData.roomTypes) {
                            let roomTypes = {};
                            try {
                                roomTypes = typeof hotelData.roomTypes === 'string' ? 
                                    JSON.parse(hotelData.roomTypes) : hotelData.roomTypes;
                            } catch (e) {
                                console.warn('Failed to parse room types:', hotelData.roomTypes);
                            }
                            
                            if (roomTypes[roomType]) {
                                roomSelectionForAPI[roomType] = {
                                    price: parseFloat(roomTypes[roomType].price),
                                    quantity: quantity
                                };
                            }
                        }
                    }
                }
            }

            // üéØ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –±–∞–∑–æ–≤–æ–π —Ü–µ–Ω–µ —Ç—É—Ä–∞
            if (!hasAnySelectedRooms) {
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±–∞–∑–æ–≤—É—é —Ü–µ–Ω—É —Ç—É—Ä–∞
                const tour = bookingState.tour;
                const urlParams = new URLSearchParams(window.location.search);
                const numberOfTourists = parseInt(urlParams.get('tourists')) || 1;
                
                let baseTourPrice = parseFloat(tour.price);
                if (isPerPersonPricing(tour.priceType)) {
                    baseTourPrice *= numberOfTourists;
                }
                
                bookingState.totalPrice = baseTourPrice;
                updateTotalPrice();
                return;
            }

            try {
                
                const meals = window.bookingStateManager.state.selections.meals || {};
                
                const response = await fetch(`/api/booking/${bookingState.bookingId}/calculate-price`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hotelId: targetHotelId,
                        roomSelection: roomSelectionForAPI,
                        mealSelection: meals
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data && data.data.totalPrice) {
                        bookingState.totalPrice = data.data.totalPrice;
                        updateTotalPrice();
                    }
                } else {
                    console.error('Price calculation failed:', response.status);
                }
            } catch (error) {
                console.error('Error calculating price:', error);
            }
        }

        // ‚úÖ NEW: Allow continuing without hotel selection
        async function continueWithoutHotel() {
            try {
                // Clear any hotel/room/meal selections
                window.bookingStateManager.setHotelInfo(null);
                window.bookingStateManager.setRoomSelection({});
                window.bookingStateManager.setMealSelection({});
                
                // Save booking with null hotel
                await saveBookingDraft();
            } catch (error) {
                console.error('‚ùå Error continuing without hotel:', error);
                showNotification(getTranslation('booking.error.continue') || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏', 'error');
            }
        }
        
        // ‚úÖ REFACTORED: Save booking draft function with bookingStateManager
        async function saveBookingDraft() {
            // ‚úÖ HOTEL AND ROOM SELECTION IS NOW OPTIONAL
            // Client can proceed with just base tour price
            
            try {
                const roomSelection = window.bookingStateManager.state.selections.rooms || {};
                const mealSelection = window.bookingStateManager.state.selections.meals || {};
                
                // ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ–º hotelId –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ (–ø–µ—Ä–≤—ã–π –æ—Ç–µ–ª—å —Å –Ω–æ–º–µ—Ä–∞–º–∏)
                let hotelId = null;
                for (const hId in roomSelection) {
                    const hotelRooms = roomSelection[hId] || {};
                    if (Object.values(hotelRooms).some(qty => parseInt(qty) > 0)) {
                        hotelId = parseInt(hId);
                        break;
                    }
                }
                
                // Update booking with selections in database as draft
                const updateData = {
                    hotelId: hotelId,
                    roomSelection: roomSelection,
                    mealSelection: mealSelection,
                    cityNights: window.bookingCityNights || null,
                    totalPrice: bookingState.totalPrice,
                    status: 'draft'
                };
                
                console.log('üîÑ Saving booking draft with room selections and cityNights:', updateData);
                
                const updateResponse = await fetch(`/api/booking/${bookingState.bookingId}/step1`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const responseData = await updateResponse.json();
                
                if (responseData.success) {
                    // üéØ –ö–†–ò–¢–ò–ß–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞!
                    const serverTotalPrice = responseData.data?.totalPrice || bookingState.totalPrice;
                    
                    // Update bookingStateManager with server-provided total
                    window.bookingStateManager.state.pricing.grandTotal = serverTotalPrice;
                    window.bookingStateManager.persist();
                    
                    console.log('‚úÖ Booking draft saved, total:', serverTotalPrice);
                    
                    // Navigate to step 2
                    window.location.href = `/booking-step2.html?bookingId=${bookingState.bookingId}`;
                } else {
                    throw new Error(responseData.message || 'Failed to save booking');
                }
                
            } catch (error) {
                console.error('‚ùå Error saving booking draft:', error);
                showNotification(getTranslation('booking.error.save_draft') + ': ' + error.message, 'error');
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–∞–ª—é—Ç (–∫–æ–ø–∏—è –∏–∑ index.html)
        let globalCurrency = 'TJS';
        let exchangeRates = {
            TJS: { rate: 1, symbol: 'tjs' }
            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞
        };

        // –§—É–Ω–∫—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ü–µ–Ω
        function convertPrice(priceInTJS, targetCurrency) {
            if (!exchangeRates[targetCurrency]) return priceInTJS;
            // –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞: –∫—É—Ä—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ TJS –∑–∞ 1 –µ–¥–∏–Ω–∏—Ü—É –≤–∞–ª—é—Ç—ã
            // –î–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–∑ TJS –≤ –¥—Ä—É–≥—É—é –≤–∞–ª—é—Ç—É: priceInTJS / rate
            return Math.round(priceInTJS / exchangeRates[targetCurrency].rate);
        }

        function convertAllPrices() {
            document.querySelectorAll('.price-display').forEach(element => {
                if (element.dataset.originalPrice) {
                    const originalPrice = parseInt(element.dataset.originalPrice);
                    const convertedPrice = convertPrice(originalPrice, globalCurrency);
                    element.textContent = `${exchangeRates[globalCurrency].symbol}${convertedPrice}`;
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadExchangeRates() {
            try {
                const response = await fetch('/api/exchange-rates');
                const data = await response.json();
                
                if (data.success) {
                    data.data.forEach(rate => {
                        exchangeRates[rate.currency] = {
                            rate: parseFloat(rate.rate),
                            symbol: rate.symbol
                        };
                    });
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤
                    convertAllPrices();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç:', error);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∞–ª—é—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
        function initializeCurrency() {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∞–ª—é—Ç—É –∏–∑ localStorage
            const savedCurrency = localStorage.getItem('selectedCurrency');
            if (savedCurrency && exchangeRates[savedCurrency]) {
                globalCurrency = savedCurrency;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç
            loadExchangeRates();
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize currency system
            initializeCurrency();
            
            // Set up continue button handler
            setTimeout(() => {
                const continueBtn = document.getElementById('continue-btn');
                if (continueBtn) {
                    continueBtn.addEventListener('click', saveBookingDraft);
                } else {
                    console.warn('‚ö†Ô∏è Continue button not found');
                }
            }, 1000); // Give time for DOM elements to be created
        });

        // Listen for language changes to update date format
        document.addEventListener('languageChanged', (e) => {
            console.log('Language changed to:', e.detail.language);
            
            // CRITICAL: Update window.currentLanguage first!
            window.currentLanguage = e.detail.language;
            
            displayTourDetails(); // Update date format and other tour details
            
            // Reload hotels from API with new language
            const urlParams = new URLSearchParams(window.location.search);
            const tourId = urlParams.get('tourId');
            if (tourId) {
                loadTourHotels(tourId).then(() => {
                    // Wait for hotels to load, then restore state
                    requestAnimationFrame(() => {
                        // Restore room/meal selections after re-render
                        Object.entries(bookingState.roomSelection).forEach(([hotelId, rooms]) => {
                            Object.entries(rooms).forEach(([roomType, quantity]) => {
                                const element = document.getElementById(`room-${hotelId}-${roomType}`);
                                if (element) element.textContent = quantity;
                            });
                        });
                        
                        // Restore meal selection radio buttons
                        Object.entries(bookingState.mealSelection).forEach(([hotelId, mealData]) => {
                            if (mealData.type) {
                                const radio = document.querySelector(`input[name="meal-${hotelId}"][value="${mealData.type}"]`);
                                if (radio) radio.checked = true;
                            }
                        });
                        
                        // Restore selected hotel highlight
                        if (bookingState.selectedHotel) {
                            const selectedCard = document.querySelector(`.hotel-card[data-hotel-id="${bookingState.selectedHotel}"]`);
                            if (selectedCard) selectedCard.classList.add('border-gray-600', 'border-2');
                        }
                        
                        updateRoomMealDisplay(); // Update room/meal display after restore
                    });
                });
            }
        });

        // Listen for currency changes from header
        document.addEventListener('currencyChanged', (e) => {
            console.log('Currency changed to:', e.detail.currency);
            globalCurrency = e.detail.currency;
            updateAllPriceDisplays(); // Update all prices with new currency
        });
    </script>
    
    <!-- Footer Container for dynamic footer -->
    <div id="footer-container"></div>
    
    <!-- Layout Loader for dynamic header/footer -->
    <script src="/public/js/layout-loader.js"></script>
</body>
</html>