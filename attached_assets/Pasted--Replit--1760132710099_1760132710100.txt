–¢–ó –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–¥–ª—è Replit)
–¶–µ–ª—å

–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö (—Ç—É—Ä—ã, –≥–∏–¥—ã –∏ —Ç.–¥.).

–ë—ã—Å—Ç—Ä—ã–π –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π —Å—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

–ß–∏—Å—Ç—ã–µ –¥–µ–ø–ª–æ–π-—Å–∫—Ä–∏–ø—Ç—ã: –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Å–∏–¥ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏, –∞ –Ω–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–µ—Å—Ç–∞—Ä—Ç–µ.

–ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è Prisma –ø—Ä–æ package.json#prisma.

–£–ø—Ä–æ—Å—Ç–∏—Ç—å —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é (healthcheck, CORS, PM2, Nginx).

1) –û–±–Ω–æ–≤–∏—Ç—å update.sh (—Å–µ—Ä–≤–µ—Ä–Ω—ã–π –¥–µ–ø–ª–æ–π-—Å–∫—Ä–∏–ø—Ç)

–§–∞–π–ª: update.sh (–≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è)
–ó–∞–¥–∞—á–∞: –∑–∞–º–µ–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∞ –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∏–∂–µ ‚Äî –æ–Ω:

–¥–µ–ª–∞–µ—Ç –±—ç–∫–∞–ø –ë–î –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º,

–ø—Ä–∏–º–µ–Ω—è–µ—Ç migrate deploy,

–∑–∞–ø—É—Å–∫–∞–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π —Å–∏–¥,

–∂–¥—ë—Ç –¥–æ 120 c –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ API (–ø—Ä—è–º–æ –Ω–∞ :5000 –∏ —á–µ—Ä–µ–∑ Nginx /api).

#!/bin/bash
set -euo pipefail

APP_NAME="bunyod-tour"
APP_DIR="/srv/bunyod-tour"   # <- –Ω–µ /var/www, –∞ –∏–º–µ–Ω–Ω–æ /srv/bunyod-tour
DB_NAME="bunyod_tour"
BACKUP_DIR="/var/backups/bunyod-tour"

HC_NODE="http://127.0.0.1:5000/api/tour-blocks"
HC_NGINX="http://127.0.0.1/api/tour-blocks"

wait_for_200 () {
  local url="$1"
  local timeout="${2:-120}"
  local i=0 code=000
  echo "ü©∫ –ñ–¥—É 200 –æ—Ç $url (timeout ${timeout}s)..."
  while [ $i -lt $timeout ]; do
    code=$(curl -s -o /dev/null -w "%{http_code}" "$url" || true)
    if [ "$code" = "200" ]; then
      echo "‚úÖ $url -> 200"
      return 0
    fi
    sleep 1; i=$((i+1))
  done
  echo "‚ùå –ù–µ –¥–æ–∂–¥–∞–ª–∏—Å—å 200 –æ—Ç $url (–ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–¥: $code)"
  return 1
}

echo "üîÑ –ù–∞—á–∏–Ω–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${APP_NAME}..."
cd "$APP_DIR"

echo "üß∑ –ë—ç–∫–∞–ø –ë–î –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º..."
mkdir -p "$BACKUP_DIR"
ts=$(date +%F_%H-%M-%S)
sudo -u postgres pg_dump -Fc -d "$DB_NAME" > "$BACKUP_DIR/${DB_NAME}_${ts}.dump"
echo "‚úÖ –ë—ç–∫–∞–ø: $BACKUP_DIR/${DB_NAME}_${ts}.dump"

echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
pm2 stop "$APP_NAME" || true

echo "üì• Git pull..."
git pull --ff-only origin main

echo "üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm ci || npm install

echo "üîß Prisma generate..."
npx prisma generate

echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω—è—é –º–∏–≥—Ä–∞—Ü–∏–∏ (deploy)..."
npx prisma migrate deploy

echo "üå± –°–∏–¥ (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫)..."
npx prisma db seed || npm run db:seed

echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 restart "$APP_NAME"
pm2 save

echo "üîé –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ—Ä—Ç 5000..."
for i in {1..60}; do
  if ss -lntp 2>/dev/null | grep -q ':5000\b'; then
    echo "‚úÖ –ü–æ—Ä—Ç 5000 —Å–ª—É—à–∞–µ—Ç—Å—è."
    break
  fi
  sleep 1
done

echo "ü©∫ Healthcheck..."
if ! wait_for_200 "$HC_NODE" 120; then
  echo "‚ÑπÔ∏è  –ü—Ä–æ–±—É—é —á–µ—Ä–µ–∑ Nginx..."
  if ! wait_for_200 "$HC_NGINX" 120; then
    echo "üîé –õ–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:"
    pm2 logs "$APP_NAME" --lines 120 || true
    systemctl status nginx --no-pager -n 0 || true
    exit 1
  fi
fi

echo "üéâ –ì–æ—Ç–æ–≤–æ."


–í–∞–∂–Ω–æ: –ø—É—Ç—å APP_DIR –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å /srv/bunyod-tour. –°–µ–π—á–∞—Å –Ω–∞ –ø—Ä–æ–¥–µ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫.

2) –ù–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏/–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –Ω–∞ –∫–∞–∂–¥–æ–º —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–°–µ–π—á–∞—Å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö: ¬´PRODUCTION MODE: –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π prisma migrate deploy¬ª. –û—Å—Ç–∞–≤–∏–º —ç—Ç–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è, –∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –≤—ã–∫–ª—é—á–∏–º, —á—Ç–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å —Ä–µ—Å—Ç–∞—Ä—Ç—ã.

–§–∞–π–ª: src/utils/initializeDatabase.ts (–∏–ª–∏ –≥–¥–µ —É –≤–∞—Å –≤—ã–∑—ã–≤–∞—é—Ç—Å—è migrate deploy / —Å–∏–¥ –≤–Ω—É—Ç—Ä–∏ boot-–ø—Ä–æ—Ü–µ—Å—Å–∞).
–°–¥–µ–ª–∞—Ç—å —Ç–∞–∫:

// –ø—Å–µ–≤–¥–æ–∫–æ–¥ ‚Äî –≤—Å—Ç–∞–≤–∏—Ç—å –≤–æ–∫—Ä—É–≥ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤—ã–∑–æ–≤–æ–≤ –≤–∞—à–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
const runMigrationsOnBoot = process.env.RUN_MIGRATIONS_ON_BOOT === 'true';
const runSeedOnBoot       = process.env.RUN_SEED_ON_BOOT === 'true';

if (runMigrationsOnBoot) {
  // –í–ê–® —Å—Ç–∞—Ä—ã–π –∫–æ–¥: –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–∑–≤–∞—Ç—å prisma migrate deploy (execSync / API)
  // execSync('npx prisma migrate deploy', { stdio: 'inherit' });
} else {
  console.log('üè≠ PRODUCTION: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º migrate deploy (RUN_MIGRATIONS_ON_BOOT!=true)');
}

if (runSeedOnBoot) {
  // –í–ê–® –∫–æ–¥ —Å–∏–¥–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –Ω–∞ –±—É—Ç–µ
  // execSync('npx prisma db seed', { stdio: 'inherit' });
} else {
  console.log('üè≠ PRODUCTION: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º seed –Ω–∞ —Å—Ç–∞—Ä—Ç–µ (RUN_SEED_ON_BOOT!=true)');
}


–ù–∞ –ø—Ä–æ–¥–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–µ–ª–∞–µ—Ç update.sh (—Å–º. –ø.1) ‚Äî —Ç–∞–º –∏ migrate deploy, –∏ db seed. –ü–æ—ç—Ç–æ–º—É –Ω–∞ BOOT —ç—Ç–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

3) –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π health-endpoint

–§–∞–π–ª: –≥–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (index.js –∏–ª–∏ src/server.ts).
–î–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–æ—É—Ç–æ–≤:

app.get('/healthz', (req, res) => {
  res.status(200).json({ ok: true, uptime: process.uptime() });
});


Healthcheck –≤ update.sh –º–æ–∂–Ω–æ –ø–æ–∑–∂–µ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ /healthz, –Ω–æ –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º /api/tour-blocks (—Ç–∞–º –µ—Å—Ç—å DB-–¥–æ—Å—Ç—É–ø, —á—Ç–æ —Ç–æ–∂–µ –Ω–µ–ø–ª–æ—Ö–æ).

4) CORS: –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–µ–π—á–∞—Å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –≤–∏–¥–Ω–æ –∂—ë—Å—Ç–∫–∏–π Access-Control-Allow-Origin: https://147.45.213.8. –ù—É–∂–Ω–∞ –≥–∏–±–∫–æ—Å—Ç—å.

–§–∞–π–ª: –≤–∞—à CORS-middleware.
–õ–æ–≥–∏–∫–∞:

CORS_ORIGINS = —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–ø—Ä–∏–º–µ—Ä: https://example.com,http://localhost:3000).

–ï—Å–ª–∏ Origin –≤ allowlist ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –≤ Access-Control-Allow-Origin, –ø–ª—é—Å credentials: true.

–î–ª—è –ø—É—Å—Ç–æ–≥–æ Origin (curl/health) ‚Äî —Ä–∞–∑—Ä–µ—à–∞—Ç—å.

–ü—Ä–∏–º–µ—Ä –Ω–∞ –ø–∞–∫–µ—Ç–µ cors:

import cors from 'cors';

const allowlist = (process.env.CORS_ORIGINS || '')
  .split(',')
  .map(s => s.trim())
  .filter(Boolean);

app.use(cors({
  origin(origin, cb) {
    if (!origin) return cb(null, true);
    cb(null, allowlist.includes(origin));
  },
  credentials: true,
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],
  methods: ['GET','POST','PUT','DELETE','PATCH','OPTIONS'],
  maxAge: 86400,
}));

5) –£–±—Ä–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ Prisma –ø—Ä–æ package.json#prisma

–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Prisma –∏–∑ package.json –≤ –Ω–æ–≤—ã–π prisma.config.ts (–∫–∞–∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç Prisma).

–£–¥–∞–ª–∏—Ç—å —Å–µ–∫—Ü–∏—é prisma –∏–∑ package.json.

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å npx prisma generate –∏ npx prisma migrate deploy ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ.

(–°—Å—ã–ª–∫—É –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –æ–Ω–∏ —É–∂–µ –¥–∞—é—Ç –≤ warning ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–ª–µ–¥—É–π—Ç–µ –µ–π.)

6) ecosystem.config.js –¥–ª—è PM2

–î–æ–±–∞–≤—å—Ç–µ –≤ —Ä–µ–ø–æ, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Ä—É—á–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤:

// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'bunyod-tour',
    cwd: '/srv/bunyod-tour',
    script: 'index.js',       // –∏–ª–∏ build/server.js ‚Äî –∫–∞–∫ —É –≤–∞—Å –≤ –ø—Ä–æ–¥–µ
    exec_mode: 'fork',
    instances: 1,
    interpreter: process.env.PM2_NODE || '/usr/bin/node',
    env: {
      NODE_ENV: 'production',
      PORT: 5000,
    },
  }],
};


–ò –≤ README –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É:

pm2 start ecosystem.config.js && pm2 save

7) .env.example

–í—ã–ª–æ–∂–∏—Ç—å —à–∞–±–ª–æ–Ω —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏/–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:

# Required
DATABASE_URL=postgresql://bunyod_user:XXXX@localhost:5432/bunyod_tour?schema=public
ADMIN_DEFAULT_USER=admin
ADMIN_DEFAULT_PASSWORD=***strong***

# Optional (—á—Ç–æ–±—ã –Ω–µ —à—É–º–µ–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è)
ALIF_MERCHANT_KEY=
ALIF_MERCHANT_PASSWORD=
SMTP_HOST=
SMTP_USER=
SMTP_PASSWORD=
STRIPE_SECRET_KEY=
PAYME_MERCHANT_ID=
CLICK_MERCHANT_ID=

# Flags
RUN_MIGRATIONS_ON_BOOT=false
RUN_SEED_ON_BOOT=false

# CORS
CORS_ORIGINS=https://example.com

8) –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–µ–ø–ª–æ—è (–¥–æ–±–∞–≤–∏—Ç—å –≤ DEPLOYMENT_GUIDE.md)

–ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx: –≤ /etc/nginx/nginx.conf –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞
include /etc/nginx/conf.d/*.conf; –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ http { ... }.
(–ë–µ–∑ —ç—Ç–æ–≥–æ —Ä–∞–Ω–µ–µ –ø–æ–ª—É—á–∞–ª–∏ 404 –Ω–∞ /api/*.)

–ö–æ–Ω—Ñ–∏–≥ bunyod-tour.conf –ø—É–±–ª–∏–∫—É–π—Ç–µ –≤ —Ä–µ–ø–æ –∫–∞–∫ –ø—Ä–∏–º–µ—Ä.

–û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ç–µ–ø–µ—Ä—å ‚Äî –ø—Ä–æ—Å—Ç–æ:

cd /srv/bunyod-tour
./update.sh

9) –ü–æ–ª–∏—Ç–∏–∫–∞ —Å–∏–¥–∏—Ä–æ–≤–∞–Ω–∏—è (–≤–∞–∂–Ω–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö)

–°–∏–¥ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π: —Ç–æ–ª—å–∫–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –±–ª–æ–∫–∏, —Å—Ç—Ä–∞–Ω—ã/–≥–æ—Ä–æ–¥–∞, –≤–∞–ª—é—Ç—ã), —á–µ—Ä–µ–∑ upsert.

–ù–µ —Å–æ–∑–¥–∞—ë—Ç –¥–µ–º–æ-—Ç—É—Ä—ã, –Ω–µ —É–¥–∞–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç.

–î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ —è–≤–Ω–æ –≤ README, —á—Ç–æ–±—ã –Ω–∏–∫—Ç–æ –Ω–µ –æ–∂–∏–¥–∞–ª –∞–≤—Ç–æ–∑–∞–ª–∏–≤–∫–∏ —Ç—É—Ä–æ–≤ –≤ –ø—Ä–æ–¥.

10) package.json ‚Äî –º–µ–ª–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

engines: –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å node >= 18 (–Ω–∞ –ø—Ä–æ–¥–µ —Å–µ–π—á–∞—Å 24 ‚Äî —Å–æ–≤–º–µ—Å—Ç–∏–º–æ).

–°–∫—Ä–∏–ø—Ç—ã:

{
  "scripts": {
    "postinstall": "prisma generate",
    "migrate:deploy": "prisma migrate deploy",
    "seed": "prisma db seed",
    "start": "node index.js"
  }
}
