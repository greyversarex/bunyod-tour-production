[root@archlinux bunyod-tour]# cat > /tmp/cleanup_missing_images.sh << 'BASH_SCRIPT'
#!/bin/bash
UPLOAD_DIR="/var/bunyod-tour/uploads/images/"
echo "üßπ –ù–∞—á–∏–Ω–∞—é –æ—á–∏—Å—Ç–∫—É –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
echo ""
# –°–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
sudo -u postgres psql -d bunyod_tour << 'SQL'
DO $$
DECLARE
    tour_rec RECORD;
    images_array jsonb;
    cleaned_images jsonb;
    file_path text;
    filename text;
    full_path text;
    original_count int;
    cleaned_count int;
    total_removed int := 0;
    tours_updated int := 0;
BEGIN
    FOR tour_rec IN
        SELECT id, title->>'ru' as title, images
        FROM tours
        WHERE images IS NOT NULL AND images != 'null' AND images != '[]'
    LOOP
        BEGIN
            images_array := tour_rec.images::jsonb;
            cleaned_images := '[]'::jsonb;
            original_count := jsonb_array_length(images_array);

            FOR i IN 0..original_count-1 LOOP
                file_path := images_array->i->>0;

                IF file_path LIKE '%/uploads/images/%' THEN
                    filename := substring(file_path from '.*/uploads/images/(.*)$');
                    full_path := '/var/bunyod-tour/uploads/images/' || filename;

                    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ shell
                    PERFORM pg_sleep(0);  -- Placeholder, —Ñ–∞–π–ª –ø—Ä–æ–≤–µ—Ä–∏–º –≤ bash

                    -- –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—É—Ç–∏
                    cleaned_images := cleaned_images || jsonb_build_array(file_path);
                ELSE
                    -- –û—Å—Ç–∞–≤–ª—è–µ–º –¥—Ä—É–≥–∏–µ –ø—É—Ç–∏ –∫–∞–∫ –µ—Å—Ç—å
                    cleaned_images := cleaned_images || jsonb_build_array(file_path);
                END IF;
            END LOOP;

        EXCEPTION WHEN OTHERS THEN
            RAISE NOTICE '–û—à–∏–±–∫–∞ –≤ —Ç—É—Ä–µ %: %', tour_rec.id, SQLERRM;
        END;
    END LOOP;

    RAISE NOTICE '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω';
END $$;
SQL
echo ""
echo "üìä –ì–µ–Ω–µ—Ä–∏—Ä—É—é SQL –¥–ª—è –æ—á–∏—Å—Ç–∫–∏..."
# –°–æ–∑–¥–∞—Ç—å SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
cat > /tmp/cleanup_images.sql << 'SQLSCRIPT'
-- –û—á–∏—Å—Ç–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
\set ON_ERROR_STOP on
BEGIN;
-- –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π —Ç—É—Ä –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ
SQLSCRIPT
# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç—É—Ä—ã –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª—ã
sudo -u postgres psql -d bunyod_tour -t -A -c "
SELECT id, title->>'ru', images
FROM tours
WHERE images IS NOT NULL AND images != 'null' AND images != '[]'
" | while IFS='|' read -r tour_id title images; do

    cleaned_images="["
    first=true

    # –ò–∑–≤–ª–µ—á—å –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
    echo "$images" | grep -o '"/uploads/images/[^"]*"' | tr -d '"' | while read -r img_path; do
        filename=$(echo "$img_path" | sed 's|.*/uploads/images/||')
        full_path="${UPLOAD_DIR}${filename}"

        if [ -f "$full_path" ]; then
            if [ "$first" = true ]; then
                cleaned_images="[\"$img_path\""
                first=false
            else
                cleaned_images="${cleaned_images},\"$img_path\""
            fi
        fi
    done

    cleaned_images="${cleaned_images}]"

    # –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ - –¥–æ–±–∞–≤–∏—Ç—å UPDATE
    if [ "$cleaned_images" != "$images" ]; then
        echo "UPDATE tours SET images = '${cleaned_images}' WHERE id = ${tour_id};" >> /tmp/cleanup_images.sql
        echo "  ‚úÖ –¢—É—Ä #${tour_id} (${title:0:40})"
    fi
done
echo "COMMIT;" >> /tmp/cleanup_images.sql
echo ""
echo "üìÑ SQL —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω: /tmp/cleanup_images.sql"
echo ""
echo "üîç –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–∫—Ä–∏–ø—Ç–∞ (–ø–µ—Ä–≤—ã–µ 20 —Å—Ç—Ä–æ–∫):"
head -20 /tmp/cleanup_images.sql
echo ""
echo "‚ùì –•–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ—á–∏—Å—Ç–∫—É? (y/n)"
read -r answer
if [ "$answer" = "y" ] || [ "$answer" = "Y" ]; then
    echo "üöÄ –í—ã–ø–æ–ª–Ω—è—é –æ—á–∏—Å—Ç–∫—É..."
    sudo -u postgres psql -d bunyod_tour -f /tmp/cleanup_images.sql
    echo ""
    echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    echo ""
    echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:"
    /tmp/check_missing_images.sh
else
    echo "‚ùå –û—á–∏—Å—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
fi
BASH_SCRIPT
[root@archlinux bunyod-tour]# chmod +x /tmp/cleanup_missing_images.sh
/tmp/cleanup_missing_images.sh
üßπ –ù–∞—á–∏–Ω–∞—é –æ—á–∏—Å—Ç–∫—É –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...

NOTICE:  –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω
DO

üìä –ì–µ–Ω–µ—Ä–∏—Ä—É—é SQL –¥–ª—è –æ—á–∏—Å—Ç–∫–∏...
  ‚úÖ –¢—É—Ä #27 (–¢—Ä–µ–∫–∫–∏–Ω–≥ –≤ –§–∞–Ω—Å–∫–∏—Ö –≥–æ—Ä–∞—Ö)
  ‚úÖ –¢—É—Ä #28 (–ü–µ—à–∞—è —ç–∫—Å–∫—É—Ä—Å–∏—è –ø–æ –ë–∏—à–∫–µ–∫—É)
  ‚úÖ –¢—É—Ä #16 (–í–µ–ª–∏–∫–∏–π –®–µ–ª–∫–æ–≤—ã–π –ü—É—Ç—å, —Å–µ–≤–µ—Ä–Ω—ã–π-2)
  ‚úÖ –¢—É—Ä #12 (–ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞ —Å –î–£–®–ê–ù–ë–ï –∑–∞ 5 –¥–Ω–µ–π)
  ‚úÖ –¢—É—Ä #14 (–î–µ–Ω—å –≤ –î—É—à–∞–Ω–±–µ)
  ‚úÖ –¢—É—Ä #24 (–¢–ï–°–¢)
  ‚úÖ –¢—É—Ä #23 (–í–æ—Å—Ç–æ—á–Ω—ã–µ –ª–µ–≥–µ–Ω–¥—ã I)
  ‚úÖ –¢—É—Ä #13 (–û–¥–∏–Ω –¥–µ–Ω—å –≤ –î—É—à–∞–Ω–±–µ)
  ‚úÖ –¢—É—Ä #15 (–≠–∫—Å–∫—É—Ä—Å–∏—è –ø–æ –î—É—à–∞–Ω–±–µ, –ø–µ—à–∞—è-1)
  ‚úÖ –¢—É—Ä #25 (–¢—É—Ä –ø–æ –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω—É, –°–∞–º–∞—Ä–∫–∞–Ω–¥—É –∏ –ë—É—Ö–∞—Ä–µ)
  ‚úÖ –¢—É—Ä #26 (–≠–∫—Å–∫—É—Ä—Å–∏—è –ø–æ –î—É—à–∞–Ω–±–µ, –ø–µ—à–∞—è-2)

üìÑ SQL —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω: /tmp/cleanup_images.sql

üîç –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–∫—Ä–∏–ø—Ç–∞ (–ø–µ—Ä–≤—ã–µ 20 —Å—Ç—Ä–æ–∫):
-- –û—á–∏—Å—Ç–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
\set ON_ERROR_STOP on
BEGIN;
-- –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π —Ç—É—Ä –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ
UPDATE tours SET images = '[]' WHERE id = 27;
UPDATE tours SET images = '[]' WHERE id = 28;
UPDATE tours SET images = '[]' WHERE id = 16;
UPDATE tours SET images = '[]' WHERE id = 12;
UPDATE tours SET images = '[]' WHERE id = 14;
UPDATE tours SET images = '[]' WHERE id = 24;
UPDATE tours SET images = '[]' WHERE id = 23;
UPDATE tours SET images = '[]' WHERE id = 13;
UPDATE tours SET images = '[]' WHERE id = 15;
UPDATE tours SET images = '[]' WHERE id = 25;
UPDATE tours SET images = '[]' WHERE id = 26;
COMMIT;

‚ùì –•–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ—á–∏—Å—Ç–∫—É? (y/n)
y
üöÄ –í—ã–ø–æ–ª–Ω—è—é –æ—á–∏—Å—Ç–∫—É...
BEGIN
UPDATE 1
UPDATE 1
UPDATE 1
UPDATE 1
UPDATE 1
UPDATE 1
UPDATE 1
UPDATE 1
UPDATE 1
UPDATE 1
UPDATE 1
COMMIT

‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!

üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
üîç –ü—Ä–æ–≤–µ—Ä—è—é —Ñ–∞–π–ª—ã —Ç—É—Ä–æ–≤...


üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
[root@archlinux bunyod-tour]#
