/**
 * üóÑÔ∏è –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–•
 * 
 * –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–∑–¥–∞–µ—Ç –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏ –Ω–∞ –Ω–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ.
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞ –µ—Å–ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞—è.
 */

import prisma from '../config/database';
import { safeInitializeWithVersioning, completeInitialization } from './migrationVersioning';

/**
 * üè∑Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –Ω–∞–±–æ—Ä—É (15 –∏—Å—Ç–∏–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π)
 */
async function migrateCategoriesToCorrectSet() {
    console.log('üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –Ω–∞–±–æ—Ä—É...');
    
    // üéØ –ò–°–¢–ò–ù–ù–´–ï –ö–ê–¢–ï–ì–û–†–ò–ò —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–º—É –º–µ–Ω—é —Å–∞–π—Ç–∞ (RU/EN –¢–û–õ–¨–ö–û!)
    const correctCategories = [
        { name: JSON.stringify({ en: "One-day", ru: "–û–¥–Ω–æ–¥–Ω–µ–≤–Ω—ã–π" }), legacyNames: ["–æ–¥–Ω–æ–¥–Ω–µ–≤–Ω—ã–µ", "–æ–¥–Ω–æ–¥–Ω–µ–≤–Ω—ã–µ —Ç—É—Ä—ã", "day", "day tours"] },
        { name: JSON.stringify({ en: "Multi-day", ru: "–ú–Ω–æ–≥–æ–¥–Ω–µ–≤–Ω—ã–π" }), legacyNames: ["–º–Ω–æ–≥–æ–¥–Ω–µ–≤–Ω—ã–µ", "–º–Ω–æ–≥–æ–¥–Ω–µ–≤–Ω—ã–µ —Ç—É—Ä—ã", "multi-day tours"] },
        { name: JSON.stringify({ en: "Excursion", ru: "–≠–∫—Å–∫—É—Ä—Å–∏—è" }), legacyNames: ["—ç–∫—Å–∫—É—Ä—Å–∏–∏", "excursions"] },
        { name: JSON.stringify({ en: "City", ru: "–ì–æ—Ä–æ–¥—Å–∫–æ–π" }), legacyNames: ["–≥–æ—Ä–æ–¥—Å–∫–∏–µ", "–≥–æ—Ä–æ–¥—Å–∫–∏–µ —Ç—É—Ä—ã", "city tours"] },
        { name: JSON.stringify({ en: "Nature/Eco", ru: "–ü—Ä–∏—Ä–æ–¥–∞/—ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π" }), legacyNames: ["–ø—Ä–∏—Ä–æ–¥–∞/—ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ", "–ø—Ä–∏—Ä–æ–¥–∞/—ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç—É—Ä—ã", "nature/ecological", "nature/ecological tours", "nature/eco tours"] },
        { name: JSON.stringify({ en: "Cultural & Educational", ru: "–ö—É–ª—å—Ç—É—Ä–Ω–æ –ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω—ã–π" }), legacyNames: ["–∫—É–ª—å—Ç—É—Ä–Ω–æ –ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω—ã–µ", "–∫—É–ª—å—Ç—É—Ä–Ω–æ –ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—É—Ä—ã", "cultural & educational tours", "cultural educational tours"] },
        { name: JSON.stringify({ en: "Historical", ru: "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π" }), legacyNames: ["–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ", "–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ç—É—Ä—ã", "historical tours"] },
        { name: JSON.stringify({ en: "Hiking/Trekking", ru: "–ü–æ—Ö–æ–¥—ã/—Ç—Ä–µ–∫–∏–Ω–≥" }), legacyNames: ["–ø–æ—Ö–æ–¥—ã/—Ç—Ä–µ–∫–∫–∏–Ω–≥–∏", "hiking/trekking"] },
        { name: JSON.stringify({ en: "Mountain Landscapes", ru: "–ì–æ—Ä–Ω—ã–µ –ª–∞–Ω–¥—à–∞—Ñ—Ç—ã" }), legacyNames: ["–≥–æ—Ä–Ω—ã–µ —Ç—É—Ä—ã", "mountain tours", "mountain landscapes"] },
        { name: JSON.stringify({ en: "Lake Landscapes", ru: "–û–∑–µ—Ä–Ω—ã–µ –ª–∞–Ω–¥—à–∞—Ñ—Ç—ã" }), legacyNames: ["–æ–∑–µ—Ä–Ω—ã–µ —Ç—É—Ä—ã", "lake tours", "lake landscapes"] },
        { name: JSON.stringify({ en: "Adventure", ru: "–ü—Ä–∏–∫–ª—é—á–µ–Ω—á–µ—Å–∫–∏–π" }), legacyNames: ["–ø—Ä–∏–∫–ª—é—á–µ–Ω—á–µ—Å–∫–∏–µ", "–ø—Ä–∏–∫–ª—é—á–µ–Ω—á–µ—Å–∫–∏–µ —Ç—É—Ä—ã", "adventure tours"] },
        { name: JSON.stringify({ en: "Gastronomic", ru: "–ì–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π" }), legacyNames: ["–≥–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ", "–≥–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Ç—É—Ä—ã", "gastronomic tours"] },
        { name: JSON.stringify({ en: "Car/Safari/Jeep", ru: "–ê–≤—Ç–æ/—Å–∞—Ñ–∞—Ä–∏/–¥–∂–∏–ø" }), legacyNames: ["–∞–≤—Ç–æ—Ç—É—Ä—ã/—Å–∞—Ñ–∞—Ä–∏/–¥–∂–∏–ø-—Ç—É—Ä—ã", "auto/safari/jeep", "auto tours/safari/jeep tours"] },
        { name: JSON.stringify({ en: "Agrotourism", ru: "–ê–≥—Ä–æ—Ç—É—Ä–∏–∑–º" }), legacyNames: ["–∞–≥—Ä–æ—Ç—É—Ä—ã", "agro tours", "agro"] },
        { name: JSON.stringify({ en: "VIP", ru: "VIP" }), legacyNames: ["vip —Ç—É—Ä—ã", "vip tours"] }
    ];
    
    try {
        const existingCategories = await prisma.categories.findMany({
            include: { _count: { select: { tours: true } } }
        });
        
        console.log(`üìä –ù–∞–π–¥–µ–Ω–æ ${existingCategories.length} —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π`);
        const processedIds = new Set();
        
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–∞–∂–¥—É—é –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        for (const canonical of correctCategories) {
            const canonicalParsed = JSON.parse(canonical.name);
            const canonicalRuNorm = canonicalParsed.ru.toLowerCase().trim();
            const canonicalEnNorm = canonicalParsed.en.toLowerCase().trim();
            
            // –ù–∞—Ö–æ–¥–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —ç—Ç–æ–π –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–π
            const matchingCategories = existingCategories.filter((cat: any) => {
                if (processedIds.has(cat.id)) return false;
                
                try {
                    const parsed = JSON.parse(cat.name);
                    const ruLower = (parsed.ru || '').toLowerCase().trim();
                    const enLower = (parsed.en || '').toLowerCase().trim();
                    
                    // Exact match first
                    if (ruLower === canonicalRuNorm || enLower === canonicalEnNorm) return true;
                    
                    // Legacy name match
                    return canonical.legacyNames.some((legacy: string) => 
                        ruLower === legacy.toLowerCase() || enLower === legacy.toLowerCase()
                    );
                } catch {
                    return false;
                }
            });
            
            if (matchingCategories.length > 0) {
                // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë
                const primary = matchingCategories[0];
                await prisma.categories.update({
                    where: { id: primary.id },
                    data: { name: canonical.name }
                });
                processedIds.add(primary.id);
                console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è ID ${primary.id}: ${primary.name} ‚Üí ${canonical.name}`);
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã, –ø–µ—Ä–µ–Ω–æ—Å–∏–º –∏—Ö —Ç—É—Ä—ã –∏ —É–¥–∞–ª—è–µ–º
                for (let i = 1; i < matchingCategories.length; i++) {
                    const duplicate = matchingCategories[i];
                    await prisma.tours.updateMany({
                        where: { categoryId: duplicate.id },
                        data: { categoryId: primary.id }
                    });
                    await prisma.categories.delete({ where: { id: duplicate.id } });
                    processedIds.add(duplicate.id);
                    console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç ID ${duplicate.id}, —Ç—É—Ä—ã –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –Ω–∞ ID ${primary.id}`);
                }
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                const newCat = await prisma.categories.create({ data: { name: canonical.name } });
                processedIds.add(newCat.id);
                console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${canonicalParsed.ru}`);
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const unmatched = existingCategories.filter((cat: any) => !processedIds.has(cat.id));
        if (unmatched.length > 0) {
            console.warn(`‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ ${unmatched.length} –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π:`);
            for (const cat of unmatched) {
                console.warn(`   - "${cat.name}" (ID: ${cat.id}, —Ç—É—Ä–æ–≤: ${cat._count.tours})`);
                // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—É—Å—Ç—ã–µ –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                if (cat._count.tours === 0) {
                    await prisma.categories.delete({ where: { id: cat.id } });
                    console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ –ø—É—Å—Ç–∞—è –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${cat.name}`);
                } else {
                    console.warn(`‚ö†Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è "${cat.name}" —Å–æ–¥–µ—Ä–∂–∏—Ç ${cat._count.tours} —Ç—É—Ä–æ–≤ –∏ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å`);
                }
            }
        }
        
        console.log(`‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –í—Å–µ–≥–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ${correctCategories.length} –∫–∞—Ç–µ–≥–æ—Ä–∏–π`);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
        throw error;
    }
}

/**
 * üè∑Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø—É—Å—Ç—ã—Ö –ë–î)
 */
async function createDefaultCategories() {
    console.log('üè∑Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é...');
    
    // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é
    await migrateCategoriesToCorrectSet();
}

/**
 * üìã –°–æ–∑–¥–∞–Ω–∏–µ –±–ª–æ–∫–æ–≤ —Ç—É—Ä–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
 */
async function createDefaultTourBlocks() {
    console.log('üìã –°–æ–∑–¥–∞–Ω–∏–µ –±–ª–æ–∫–æ–≤ —Ç—É—Ä–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é...');
    
    const tourBlocks = [
        {
            title: JSON.stringify({ ru: "–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç—É—Ä—ã", en: "Popular Tours" }),
            description: JSON.stringify({ ru: "–°–∞–º—ã–µ –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã–µ —Ç—É—Ä—ã –Ω–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏", en: "Most popular tours of our company" }),
            slug: "popular-tours",
            isActive: true,
            sortOrder: 1,,
            updatedAt: new Date()
            updatedAt: new Date()
        },
        {
            title: JSON.stringify({ ru: "–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Ç—É—Ä—ã –ø–æ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ê–∑–∏–∏", en: "Recommended Central Asia Tours" }),
            description: JSON.stringify({ ru: "–õ—É—á—à–∏–µ —Ç—É—Ä—ã –¥–ª—è –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ —Å –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ê–∑–∏–µ–π", en: "Best tours to discover Central Asia" }),
            slug: "recommended-central-asia",
            isActive: true,
            sortOrder: 2,
            updatedAt: new Date()
        },
        {
            title: JSON.stringify({ ru: "–¢—É—Ä—ã –ø–æ –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω—É", en: "Tajikistan Tours" }),
            description: JSON.stringify({ ru: "–û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –∫—Ä–∞—Å–æ—Ç—ã –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω–∞", en: "Discover the beauty of Tajikistan" }),
            slug: "tajikistan-tours",
            isActive: true,
            sortOrder: 3,
            updatedAt: new Date()
        },
        {
            title: JSON.stringify({ ru: "–¢—É—Ä—ã –ø–æ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω—É", en: "Uzbekistan Tours" }),
            description: JSON.stringify({ ru: "–ò—Å—Å–ª–µ–¥—É–π—Ç–µ –¥—Ä–µ–≤–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞", en: "Explore ancient cities of Uzbekistan" }),
            slug: "uzbekistan-tours",
            isActive: true,
            sortOrder: 4,
            updatedAt: new Date()
        },
        {
            title: JSON.stringify({ ru: "–¢—É—Ä—ã –ø–æ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω—É", en: "Kyrgyzstan Tours" }),
            description: JSON.stringify({ ru: "–ì–æ—Ä–Ω—ã–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –≤ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–µ", en: "Mountain adventures in Kyrgyzstan" }),
            slug: "kyrgyzstan-tours",
            isActive: true,
            sortOrder: 5,
            updatedAt: new Date()
        },
        {
            title: JSON.stringify({ ru: "–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ —Ç—É—Ä—ã", en: "Exclusive Tours" }),
            description: JSON.stringify({ ru: "–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã", en: "Unique and exclusive tour programs" }),
            slug: "exclusive-tours",
            isActive: true,
            sortOrder: 6,
            updatedAt: new Date()
        }
    ];
    
    for (const block of tourBlocks) {
        await prisma.tour_blocks.create({
            data: block
        });
    }
    
    console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${tourBlocks.length} –±–ª–æ–∫–æ–≤ —Ç—É—Ä–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é`);
}

/**
 * üåç –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
 */
async function createDefaultCountries() {
    console.log('üåç –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é...');
    
    const countries = [
        { name: "–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω", name_ru: "–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω", name_en: "Tajikistan", code: "TJ" },,
        updatedAt: new Date()
        { name: "–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω", name_ru: "–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω", name_en: "Uzbekistan", code: "UZ" },
        { name: "–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω", name_ru: "–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω", name_en: "Kyrgyzstan", code: "KG" },
        { name: "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω", name_ru: "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω", name_en: "Kazakhstan", code: "KZ" },
        { name: "–¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω", name_ru: "–¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω", name_en: "Turkmenistan", code: "TM" },
        updatedAt: new Date()
    ];
    
    for (const country of countries) {
        await prisma.countries.create({
            data: country
        });
    }
    
    console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${countries.length} —Å—Ç—Ä–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é`);
}

/**
 * üèôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
 */
async function createDefaultCities() {
    console.log('üèôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é...');
    
    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º ID —Å—Ç—Ä–∞–Ω
    const countries = await prisma.countries.findMany();
    const countryMap = new Map();
    countries.forEach((country: any) => {
        countryMap.set(country.name, country.id);
    });
    
    const cities = [
        { name: "–î—É—à–∞–Ω–±–µ", name_ru: "–î—É—à–∞–Ω–±–µ", name_en: "Dushanbe", countryId: countryMap.get("–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω") },
        { name: "–•—É–¥–∂–∞–Ω–¥", name_ru: "–•—É–¥–∂–∞–Ω–¥", name_en: "Khujand", countryId: countryMap.get("–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω") },
        { name: "–•–æ—Ä–æ–≥", name_ru: "–•–æ—Ä–æ–≥", name_en: "Khorog", countryId: countryMap.get("–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω") },
        { name: "–¢–∞—à–∫–µ–Ω—Ç", name_ru: "–¢–∞—à–∫–µ–Ω—Ç", name_en: "Tashkent", countryId: countryMap.get("–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω") },
        { name: "–°–∞–º–∞—Ä–∫–∞–Ω–¥", name_ru: "–°–∞–º–∞—Ä–∫–∞–Ω–¥", name_en: "Samarkand", countryId: countryMap.get("–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω") },
        { name: "–ë—É—Ö–∞—Ä–∞", name_ru: "–ë—É—Ö–∞—Ä–∞", name_en: "Bukhara", countryId: countryMap.get("–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω") },
        { name: "–ë–∏—à–∫–µ–∫", name_ru: "–ë–∏—à–∫–µ–∫", name_en: "Bishkek", countryId: countryMap.get("–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω") },
        { name: "–ê—Å—Ç–∞–Ω–∞", name_ru: "–ê—Å—Ç–∞–Ω–∞", name_en: "Astana", countryId: countryMap.get("–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω") },
        { name: "–ê–ª–º–∞—Ç—ã", name_ru: "–ê–ª–º–∞—Ç—ã", name_en: "Almaty", countryId: countryMap.get("–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω") },
        { name: "–ê—à—Ö–∞–±–∞–¥", name_ru: "–ê—à—Ö–∞–±–∞–¥", name_en: "Ashgabat", countryId: countryMap.get("–¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω") }
    ];
    
    for (const city of cities) {
        if (city.countryId) {
            await prisma.cities.create({
                data: city
            });
        }
    }
    
    console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${cities.length} –≥–æ—Ä–æ–¥–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é`);
}

/**
 * üé¨ –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–∞–π–¥–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
 */
async function createDefaultSlides() {
    console.log('üé¨ –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–∞–π–¥–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é...');
    
    const slides = [
        {
            title: JSON.stringify({ 
                ru: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é –ê–∑–∏—é", 
                en: "Welcome to Central Asia" 
            }),
            description: JSON.stringify({ 
                ru: "–û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ–π–∑–∞–∂–∏ –∏ –±–æ–≥–∞—Ç—É—é –∫—É–ª—å—Ç—É—Ä—É —Ä–µ–≥–∏–æ–Ω–∞", 
                en: "Discover amazing landscapes and rich culture of the region" 
            }),
            image: "/public/images/default-slide-1.jpg",
            link: "/tours",
            isActive: true,
            order: 1,
        updatedAt: new Date()
        },
        {
            title: JSON.stringify({ 
                ru: "–ù–µ–∑–∞–±—ã–≤–∞–µ–º—ã–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è", 
                en: "Unforgettable Adventures" 
            }),
            description: JSON.stringify({ 
                ru: "–ì–æ—Ä—ã, –æ–∑–µ—Ä–∞, –¥—Ä–µ–≤–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ - –≤—Å–µ —ç—Ç–æ –∂–¥–µ—Ç –≤–∞—Å", 
                en: "Mountains, lakes, ancient cities - all this awaits you" 
            }),
            image: "/public/images/default-slide-2.jpg", 
            link: "/tours",
            isActive: true,
            order: 2,
        updatedAt: new Date()
        },
        {
            title: JSON.stringify({ 
                ru: "–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –≥–∏–¥—ã", 
                en: "Expert Guides" 
            }),
            description: JSON.stringify({ 
                ru: "–ù–∞—à–∏ –æ–ø—ã—Ç–Ω—ã–µ –≥–∏–¥—ã –ø–æ–∫–∞–∂—É—Ç –≤–∞–º –ª—É—á—à–∏–µ –º–µ—Å—Ç–∞ —Ä–µ–≥–∏–æ–Ω–∞", 
                en: "Our experienced guides will show you the best places in the region" 
            }),
            image: "/public/images/default-slide-3.jpg",
            link: "/guides", 
            isActive: true,
            order: 3,
        updatedAt: new Date()
        }
    ];
    
    for (const slide of slides) {
        await prisma.slides.create({
            data: slide
        });
    }
    
    console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${slides.length} —Å–ª–∞–π–¥–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é`);
}

/**
 * üí± –°–æ–∑–¥–∞–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
 */
async function createDefaultExchangeRates() {
    console.log('üí± –°–æ–∑–¥–∞–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é...');
    
    const defaultRates = [
        {
            currency: 'TJS',
            rate: 1,
            symbol: 'tjs',
            name: '–°–æ–º–æ–Ω–∏',
            isActive: true
        },
        {
            currency: 'USD',
            rate: 11.0,
            symbol: '$',
            name: '–î–æ–ª–ª–∞—Ä –°–®–ê',
            isActive: true
        },
        {
            currency: 'EUR',
            rate: 12.0,
            symbol: '‚Ç¨',
            name: '–ï–≤—Ä–æ',
            isActive: true
        },
        {
            currency: 'RUB',
            rate: 0.12,
            symbol: '‚ÇΩ',
            name: '–†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å',
            isActive: true
        },
        {
            currency: 'CNY',
            rate: 1.5,
            symbol: '¬•',
            name: '–ö–∏—Ç–∞–π—Å–∫–∏–π —é–∞–Ω—å',
            isActive: true
        }
    ];
    
    for (const rate of defaultRates) {
        await prisma.exchange_rates.create({
            data: rate
        });
    }
    
    console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${defaultRates.length} –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é`);
}

/**
 * üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
 */
async function checkDatabaseInitialization() {
    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');
    
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
        const [categoryCount, tourBlockCount, countryCount, cityCount, slideCount, exchangeRateCount] = await Promise.all([
            prisma.categories.count(),
            prisma.tour_blocks.count(),
            prisma.countries.count(),
            prisma.cities.count(),
            prisma.slides.count(),
            prisma.exchange_rates.count()
        ]);
        
        console.log(`üìä –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î:`);
        console.log(`   Categories: ${categoryCount}`);
        console.log(`   Tour Blocks: ${tourBlockCount}`);
        console.log(`   Countries: ${countryCount}`);
        console.log(`   Cities: ${cityCount}`);
        console.log(`   Slides: ${slideCount}`);
        console.log(`   Exchange Rates: ${exchangeRateCount}`);
        
        return {
            categories: categoryCount,
            tourBlocks: tourBlockCount,
            countries: countryCount,
            cities: cityCount,
            slides: slideCount,
            exchangeRates: exchangeRateCount
        };
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ë–î:', error);
        return null;
    }
}

/**
 * üöÄ –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò
 */
export async function initializeDatabase() {
    console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');
    
    try {
        // üîí –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏  
        const shouldInitialize = await safeInitializeWithVersioning();
        
        // üìä –í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î
        const stats = await checkDatabaseInitialization();
        
        if (!stats) {
            console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é');
            return false;
        }
        
        // üí± –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç —Å–æ–∑–¥–∞—é—Ç—Å—è –í–°–ï–ì–î–ê –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤–∞–ª—é—Ç –ø—Ä–∏ –ª—é–±–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
        if (stats.exchangeRates === 0) {
            console.log('üí± –í–∞–ª—é—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç - —Å–æ–∑–¥–∞—ë–º –±–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä...');
            await createDefaultExchangeRates();
        } else {
            console.log('‚úÖ –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ');
        }
        
        // üè∑Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ú–∏–≥—Ä–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –í–°–ï–ì–î–ê
        // –≠—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏ –ª—é–±–æ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏
        console.log('üè∑Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –º–∏–≥—Ä–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º—É –Ω–∞–±–æ—Ä—É...');
        await createDefaultCategories();
        
        // –ï—Å–ª–∏ –ë–î —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –º–∏–≥—Ä–∞—Ü–∏—è–º, –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        if (!shouldInitialize) {
            console.log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –≤–µ—Ä—Å–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π');
            return true;
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ò–î–ï–ú–ü–û–¢–ï–ù–¢–ù–û (–Ω–µ –ª–æ–º–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏)
        
        if (stats.countries === 0) {
            await createDefaultCountries();
        } else {
            console.log('‚úÖ –°—Ç—Ä–∞–Ω—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ');
        }
        
        if (stats.cities === 0) {
            await createDefaultCities();
        } else {
            console.log('‚úÖ –ì–æ—Ä–æ–¥–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ');
        }
        
        if (stats.tourBlocks === 0) {
            await createDefaultTourBlocks();
        } else {
            console.log('‚úÖ –ë–ª–æ–∫–∏ —Ç—É—Ä–æ–≤ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ');
        }
        
        if (stats.slides === 0) {
            await createDefaultSlides();
        } else {
            console.log('‚úÖ –°–ª–∞–π–¥—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ');
        }
        
        // üéØ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Ä—Å–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        await completeInitialization();
        
        console.log('üéâ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
        
        // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        await checkDatabaseInitialization();
        
        return true;
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î:', error);
        return false;
    } finally {
        await prisma.$disconnect();
    }
}

/**
 * üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
 */
export async function forceResetDatabase() {
    console.log('üîß –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –ü–ï–†–ï–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–î...');
    
    try {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
        await prisma.tour_block_assignments.deleteMany();
        await prisma.slides.deleteMany();
        await prisma.cities.deleteMany();
        await prisma.countries.deleteMany();
        await prisma.tour_blocks.deleteMany();
        await prisma.categories.deleteMany();
        
        console.log('üóëÔ∏è –í—Å–µ –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');
        
        // –°–æ–∑–¥–∞–µ–º –∑–∞–Ω–æ–≤–æ
        await initializeDatabase();
        
        return true;
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ë–î:', error);
        return false;
    }
}